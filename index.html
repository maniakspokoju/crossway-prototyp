<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway 2.3</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<style>
    #map { height: 500px; margin-top: 20px; }
</style>
</head>
<body>
<h1>Crossway 2.3</h1>
<p>Wybierz swoją rolę i sprawdź geolokalizację</p>

<button id="driverBtn">Driver</button>
<button id="passengerBtn">Passenger</button>
<p id="role"></p>

<div id="passengerDestinationDiv" style="display:none; margin-top:10px;">
    <h3>Wskaż lokalizację docelową:</h3>
    <input type="number" id="destLat" placeholder="###" step="0.001">
    <input type="number" id="destLng" placeholder="###" step="0.001">
    <button id="saveDestinationBtn">Zapisz cel</button>
</div>

<div id="map" style="display:none;"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  authDomain: "crossway-prototyp.firebaseapp.com",
  projectId: "crossway-prototyp",
  storageBucket: "crossway-prototyp.firebasestorage.app",
  messagingSenderId: "852476458596",
  appId: "1:852476458596:web:f901da16de7dc8a3551171",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
db.ref("session").remove();

let currentRole = null;
let map, driverRouteControl, passengerRouteControl, commonPolyline;
let passengerMarker = null;

// WebSocket
const socket = new WebSocket("ws://localhost:8080"); // zmień URL jeśli potrzebne

socket.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if(data.type === "driverData" && currentRole === "passenger") {
        const driverStart = [data.data.start.lat, data.data.start.lng];
        const driverEnd = [data.data.destination.lat, data.data.destination.lng];

        if(driverRouteControl) map.removeControl(driverRouteControl);
        driverRouteControl = L.Routing.control({
            waypoints: [driverStart, driverEnd],
            routeWhileDragging: false,
            addWaypoints: false
        }).addTo(map);

        // Po wyznaczeniu trasy sprawdź wspólny odcinek
        driverRouteControl.on('routesfound', () => {
            if(passengerRouteControl) computeCommonSection();
        });
    }
};

function assignRole(role) {
    currentRole = role;
    document.getElementById("role").innerText = "Twoja rola: " + role;
    db.ref(`session/${role}`).set({role: role});

    if(role === "driver" && "geolocation" in navigator) {
        // Ciągłe aktualizowanie lokalizacji
        navigator.geolocation.watchPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const destLat = lat + 0.018;
            const destLng = lng + 0.018;

            db.ref("session/driver").set({
                currentLocation: {latitude: lat, longitude: lng},
                destination: {latitude: destLat, longitude: destLng}
            });

            if(socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: "driverData",
                    data: {start:{lat,lng}, destination:{lat:destLat,lng:destLng}}
                }));
            }
        });
    }

    if(role === "passenger") {
        document.getElementById("passengerDestinationDiv").style.display = "block";
        document.getElementById("map").style.display = "block";

        map = L.map('map').setView([52.1060, 19.9358], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);

        const passengerStart = [52.005, 19.905];  // demo
        const passengerEnd = [52.020, 19.920];    // demo, później z inputa

        passengerRouteControl = L.Routing.control({
            waypoints: [passengerStart, passengerEnd],
            routeWhileDragging: false,
            addWaypoints: false
        }).addTo(map);

        passengerRouteControl.on('routesfound', () => {
            if(driverRouteControl) computeCommonSection();
        });
    }
}

function computeCommonSection() {
    if(!driverRouteControl || !passengerRouteControl) return;

    const driverCoords = driverRouteControl.getRouter()._routes[0].coordinates;
    const passengerCoords = passengerRouteControl.getRouter()._routes[0].coordinates;

    let startIdx = -1;
    for(let i=0;i<passengerCoords.length;i++){
        for(let j=0;j<driverCoords.length;j++){
            if(map.distance(passengerCoords[i], driverCoords[j]) <= 50) { startIdx=j; break; }
        }
        if(startIdx>=0) break;
    }
    if(startIdx<0) return;

    let endIdx = -1;
    for(let i=passengerCoords.length-1;i>=0;i--){
        for(let j=driverCoords.length-1;j>=0;j--){
            if(map.distance(passengerCoords[i], driverCoords[j]) <= 50) { endIdx=j; break; }
        }
        if(endIdx>=0) break;
    }
    if(endIdx <= startIdx) return;

    const common = driverCoords.slice(startIdx, endIdx+1);

    if(commonPolyline) map.removeLayer(commonPolyline);
    commonPolyline = L.polyline(common, {color:'red', weight:6}).addTo(map);
}

document.getElementById("driverBtn").addEventListener("click", ()=>assignRole("driver"));
document.getElementById("passengerBtn").addEventListener("click", ()=>assignRole("passenger"));

document.getElementById("saveDestinationBtn").addEventListener("click", ()=>{
    const latSuffix = document.getElementById("destLat").value.trim();
    const lngSuffix = document.getElementById("destLng").value.trim();
    if(latSuffix.length===3 && lngSuffix.length===3){
        const lat = 52.1 + parseInt(latSuffix)/10000; 
        const lng = 19.9 + parseInt(lngSuffix)/10000;
        db.ref("session/passenger/destination").set({latitude: lat, longitude: lng});

        if(passengerMarker) map.removeLayer(passengerMarker);
        passengerMarker = L.marker([lat,lng]).addTo(map).bindPopup("Twój cel").openPopup();

        if(passengerRouteControl) {
            const start = passengerRouteControl.getWaypoints()[0].latLng;
            map.removeControl(passengerRouteControl);
            passengerRouteControl = L.Routing.control({
                waypoints: [start, L.latLng(lat,lng)],
                routeWhileDragging: false,
                addWaypoints: false
            }).addTo(map);
            passengerRouteControl.on('routesfound', () => { if(driverRouteControl) computeCommonSection(); });
        }
    } else alert("Wprowadź dokładnie 3 cyfry dla szerokości i długości!");
});
</script>
</body>
</html>
