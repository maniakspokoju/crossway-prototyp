<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway Grid Test</title>
<style>
  body { font-family: Arial, sans-serif; }
  #controls { margin-bottom: 10px; }
  button { margin: 2px; padding: 5px 10px; }
  #board { border-collapse: collapse; margin-bottom: 20px; }
  #board td { width: 40px; height: 40px; border: 1px solid #555; text-align: center; vertical-align: middle; }
  #usersTable { border-collapse: collapse; margin-top: 10px; }
  #usersTable td, #usersTable th { border: 1px solid #555; padding: 4px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

<div id="controls">
  <button id="btnDriver">Kierowca</button>
  <button id="btnPassenger">Pasażer</button>
  <button id="btnAccept" disabled>AKCEPTUJ</button>
  <button id="btnNext" disabled>Dalej</button>
  <button id="btnPrev" disabled>Cofnij</button>
  <button id="btnReset">Zakończ przejazd</button>
</div>

<table id="board"></table>

<h3>Użytkownicy:</h3>
<table id="usersTable">
<thead>
<tr><th>ID</th><th>Rola</th><th>Kolor</th><th>Start</th><th>Cel</th><th>Na trasie</th></tr>
</thead>
<tbody></tbody>
</table>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "<API_KEY>",
  authDomain: "<PROJECT_ID>.firebaseapp.com",
  databaseURL: "<DATABASE_URL>",
  projectId: "<PROJECT_ID>",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global vars
let userId = 'user_' + Math.random().toString(36).substr(2, 5);
let currentRole = null;
let board = [];
let selectedStart = null;
let selectedEnd = null;
let userColor = null;
let routeIndex = 0;

// Szachownica A-H, 1-8
const rows = 8, cols = 8;
const letters = ['A','B','C','D','E','F','G','H'];
const numbers = ['1','2','3','4','5','6','7','8'];

const boardTable = document.getElementById('board');
function createBoard() {
  boardTable.innerHTML = '';
  const header = boardTable.insertRow();
  header.insertCell(); // empty corner
  for (let c=0;c<cols;c++) { header.insertCell().innerText = letters[c]; }
  for (let r=0;r<rows;r++) {
    const row = boardTable.insertRow();
    row.insertCell().innerText = numbers[r];
    for (let c=0;c<cols;c++) {
      const cell = row.insertCell();
      cell.dataset.row = r;
      cell.dataset.col = c;
      cell.addEventListener('click', onCellClick);
      board[r] = board[r] || [];
      board[r][c] = null;
    }
  }
}
createBoard();

function onCellClick(e){
  const r = parseInt(e.target.dataset.row);
  const c = parseInt(e.target.dataset.col);
  if(!selectedStart) {
    selectedStart = {row:r,col:c};
    e.target.style.border = '3px solid black';
  } else if(!selectedEnd) {
    selectedEnd = {row:r,col:c};
    // tylko prosta linia
    if(r!==selectedStart.row && c!==selectedStart.col){
      alert('Wybierz cel w tej samej linii lub kolumnie!');
      selectedEnd = null;
      return;
    }
    e.target.style.border = '3px solid black';
    saveRoute();
  }
}

function saveRoute(){
  const color = userColor;
  db.ref('users/'+userId).set({role: currentRole, start:selectedStart, end:selectedEnd, color: color});
  document.getElementById('btnAccept').disabled = false;
}

// Role buttons
document.getElementById('btnDriver').onclick = () => setRole('driver');
document.getElementById('btnPassenger').onclick = () => setRole('passenger');
function setRole(role){
  currentRole = role;
  userColor = role==='driver'? randomColor() : 'green';
  document.body.style.backgroundColor = role==='driver'?'#ADD8E6':'#90EE90';
  document.getElementById('btnDriver').disabled = true;
  document.getElementById('btnPassenger').disabled = true;
}

function randomColor(){ return '#'+Math.floor(Math.random()*16777215).toString(16); }

// Accept button
document.getElementById('btnAccept').onclick = () => {
  db.ref('users/'+userId+'/accepted').set(true);
  document.getElementById('btnAccept').disabled = true;
  document.getElementById('btnNext').disabled = true;
  document.getElementById('btnPrev').disabled = true;
};

// Reset button
document.getElementById('btnReset').onclick = () => {
  db.ref('users').remove();
  location.reload();
};

// Listen to all users
db.ref('users').on('value', snapshot => {
  const users = snapshot.val() || {};
  updateUsersTable(users);
  updateBoard(users);
});

function updateUsersTable(users){
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  Object.keys(users).forEach(id=>{
    const u = users[id];
    const tr = tbody.insertRow();
    tr.insertCell().innerText = id;
    tr.insertCell().innerText = u.role;
    const colorCell = tr.insertCell();
    colorCell.style.backgroundColor = u.color;
    tr.insertCell().innerText = u.start?letters[u.start.col]+numbers[u.start.row]:'';
    tr.insertCell().innerText = u.end?letters[u.end.col]+numbers[u.end.row]:'';
    tr.insertCell().innerText = u.accepted?'Tak':'Nie';
  });
}

function updateBoard(users){
  // clear board
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const cell = boardTable.rows[r+1].cells[c+1];
      cell.style.backgroundColor='white';
    }
  }
  Object.keys(users).forEach(id=>{
    const u = users[id];
    if(u.start && u.end){
      const r1 = u.start.row, c1=u.start.col;
      const r2 = u.end.row, c2=u.end.col;
      const color = u.color;
      if(r1===r2){
        const minC=Math.min(c1,c2), maxC=Math.max(c1,c2);
        for(let c=minC;c<=maxC;c++) boardTable.rows[r1+1].cells[c+1].style.backgroundColor=color;
      } else {
        const minR=Math.min(r1,r2), maxR=Math.max(r1,r2);
        for(let r=minR;r<=maxR;r++) boardTable.rows[r+1].cells[c1+1].style.backgroundColor=color;
      }
    }
  });
}

</script>
</body>
</html>
