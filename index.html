<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>CROSSWAY – GRID PROTOTYP</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    margin: 0;
    padding: 20px;
  }
  body.driver { background: #1e2f1e; }
  body.passenger { background: #2f1e1e; }

  h1 { margin-top: 0; }

  button {
    padding: 8px 14px;
    margin: 4px;
    cursor: pointer;
  }

  table {
    border-collapse: collapse;
    margin-top: 10px;
  }
  td, th {
    border: 1px solid #555;
    width: 40px;
    height: 40px;
    text-align: center;
    cursor: pointer;
  }

  .grid td {
    background: #333;
  }
  .driver-cell { background: #2ecc71 !important; }
  .passenger-cell { background: #e74c3c !important; }
  .shared-cell { background: #f1c40f !important; color: #000; }

  .panel {
    margin-top: 20px;
  }

  .small {
    font-size: 12px;
    opacity: 0.8;
  }
</style>
</head>
<body>

<h1>CROSSWAY – GRID PROTOTYP</h1>

<div>
  <button onclick="selectRole('driver')">KIEROWCA</button>
  <button onclick="selectRole('passenger')">PASAŻER</button>
</div>

<div class="panel">
  <strong>Wybierz START, potem CEL</strong>
  <div id="status" class="small"></div>
</div>

<table class="grid" id="grid"></table>

<div class="panel">
  <h3>UŻYTKOWNICY (REALTIME)</h3>
  <table id="usersTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Rola</th>
        <th>Start</th>
        <th>Cel</th>
        <th>Na trasie kierowcy</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* === FIREBASE CONFIG === */
const firebaseConfig = {
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* === USER === */
const userId = crypto.randomUUID();
const userRef = db.ref("users/" + userId);

let role = null;
let start = null;
let end = null;
let allUsers = {};

/* === GRID === */
const letters = ["A","B","C","D","E","F","G","H"];
const grid = document.getElementById("grid");

function buildGrid() {
  grid.innerHTML = "";
  for (let y = 8; y >= 1; y--) {
    const tr = document.createElement("tr");
    for (let x = 0; x < 8; x++) {
      const td = document.createElement("td");
      const cell = letters[x] + y;
      td.textContent = cell;
      td.onclick = () => selectCell(cell);
      tr.appendChild(td);
    }
    grid.appendChild(tr);
  }
}
buildGrid();

/* === ROLE === */
function selectRole(r) {
  if (role) return;
  role = r;
  document.body.classList.add(r);
  userRef.set({ role });
}

/* === CELL SELECTION === */
function selectCell(cell) {
  if (!role) return;

  if (!start) {
    start = cell;
    updateStatus();
    sync();
  } else if (!end) {
    if (!validRoute(start, cell)) {
      alert("Trasa musi być w jednej linii");
      return;
    }
    end = cell;
    updateStatus();
    sync();
  }
}

/* === ROUTE LOGIC === */
function validRoute(a, b) {
  return a[0] === b[0] || a.slice(1) === b.slice(1);
}

function buildRoute(a, b) {
  const route = [];
  if (a[0] === b[0]) {
    const col = a[0];
    let y1 = +a.slice(1);
    let y2 = +b.slice(1);
    for (let y = Math.min(y1,y2); y <= Math.max(y1,y2); y++)
      route.push(col + y);
  } else {
    const row = a.slice(1);
    let x1 = letters.indexOf(a[0]);
    let x2 = letters.indexOf(b[0]);
    for (let x = Math.min(x1,x2); x <= Math.max(x1,x2); x++)
      route.push(letters[x] + row);
  }
  return route;
}

/* === SYNC === */
function sync() {
  if (!role || !start || !end) return;
  userRef.update({
    role,
    start,
    end,
    route: buildRoute(start, end)
  });
}

/* === RENDER === */
db.ref("users").on("value", snap => {
  allUsers = snap.val() || {};
  renderGrid();
  renderTable();
});

function renderGrid() {
  [...document.querySelectorAll(".grid td")].forEach(td => {
    td.className = "";
  });

  const drivers = Object.values(allUsers).filter(u => u.role === "driver");
  const passengers = Object.values(allUsers).filter(u => u.role === "passenger");

  drivers.forEach(d => {
    (d.route || []).forEach(c => markCell(c, "driver-cell"));
  });

  passengers.forEach(p => {
    markCell(p.start, "passenger-cell");
    drivers.forEach(d => {
      if ((d.route || []).includes(p.start))
        markCell(p.start, "shared-cell");
    });
  });
}

function markCell(cell, cls) {
  [...grid.querySelectorAll("td")].forEach(td => {
    if (td.textContent === cell) td.classList.add(cls);
  });
}

/* === TABLE === */
function renderTable() {
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";

  const drivers = Object.values(allUsers).filter(u => u.role === "driver");

  Object.entries(allUsers).forEach(([id,u]) => {
    const tr = document.createElement("tr");
    const onRoute = (u.role === "passenger" && drivers.some(d => (d.route||[]).includes(u.start)))
      ? "TAK" : "-";

    tr.innerHTML = `
      <td>${id.slice(0,6)}</td>
      <td>${u.role || "-"}</td>
      <td>${u.start || "-"}</td>
      <td>${u.end || "-"}</td>
      <td>${onRoute}</td>
    `;
    tbody.appendChild(tr);
  });
}

function updateStatus() {
  document.getElementById("status").textContent =
    `START: ${start || "-"} | CEL: ${end || "-"}`;
}
</script>

</body>
</html>
