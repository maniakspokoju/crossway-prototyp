<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Crossway 2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map { height: 500px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Crossway 2.0</h1>
    <p>Wybierz swoją rolę i sprawdź geolokalizację</p>

    <button id="driverBtn">Driver</button>
    <button id="passengerBtn">Passenger</button>
    <p id="role"></p>

    <!-- Pasażer wybiera cel -->
    <div id="passengerDestinationDiv" style="display:none; margin-top:10px;">
        <h3>Wskaż lokalizację docelową:</h3>
        <input type="number" id="destLat" placeholder="###" step="0.001">
        <input type="number" id="destLng" placeholder="###" step="0.001">
        <button id="saveDestinationBtn">Zapisz cel</button>
    </div>

    <div id="map" style="display:none;"></div>

<!-- Firebase App (Core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  authDomain: "crossway-prototyp.firebaseapp.com",
  projectId: "crossway-prototyp",
  storageBucket: "crossway-prototyp.firebasestorage.app",
  messagingSenderId: "852476458596",
  appId: "1:852476458596:web:f901da16de7dc8a3551171",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Reset sesji dla testów
database.ref("session").remove()
  .then(() => console.log("Sesja zresetowana"))
  .catch(err => console.error("Błąd resetu sesji:", err));

let currentRole = null;

// Funkcja przydziału roli
function assignRole(role) {
  currentRole = role;
  document.getElementById("role").innerText = "Twoja rola: " + role;

  // Zapis roli w Firebase
  database.ref(`session/${role}`).set({role: role})
    .then(() => console.log("Rola zapisana:", role))
    .catch(err => console.error("Błąd zapisu roli:", err));

  // Driver: zapis aktualnej i docelowej lokalizacji
  if (role === "driver" && "geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      database.ref("session/driver/currentLocation").set({ latitude: lat, longitude: lng });
      // Docelowa lokalizacja driver (ok. 2km dalej)
      const destinationLat = lat + 0.018;
      const destinationLng = lng + 0.018;
      database.ref("session/driver/destination").set({ latitude: destinationLat, longitude: destinationLng });
    }, error => console.error(error.message));
  }

  // Passenger: pokaż panel wyboru celu i mapę
  if (role === "passenger") {
    document.getElementById("passengerDestinationDiv").style.display = "block";
    document.getElementById("map").style.display = "block";

    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        database.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng });
      }, error => console.error(error.message));
    }

    // Inicjalizacja mapy
    const map = L.map('map').setView([52.0, 19.9], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    const driverMarker = L.marker([0,0]).addTo(map).bindPopup("Driver");
    const passengerMarker = L.marker([0,0]).addTo(map).bindPopup("Passenger");
    const driverDestMarker = L.marker([0,0], {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [25,25]})}).addTo(map).bindPopup("Driver Destination");
    const passengerDestMarker = L.marker([0,0], {icon: L.icon({iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [25,25]})}).addTo(map).bindPopup("Passenger Destination");

    // Odczyt z Firebase i aktualizacja markerów
    const updateMarkers = () => {
      database.ref("session/driver/currentLocation").once("value").then(snap => {
        const loc = snap.val();
        if(loc) driverMarker.setLatLng([loc.latitude, loc.longitude]);
      });
      database.ref("session/driver/destination").once("value").then(snap => {
        const loc = snap.val();
        if(loc) driverDestMarker.setLatLng([loc.latitude, loc.longitude]);
      });
      database.ref("session/passenger/currentLocation").once("value").then(snap => {
        const loc = snap.val();
        if(loc) passengerMarker.setLatLng([loc.latitude, loc.longitude]);
      });
      database.ref("session/passenger/destination").once("value").then(snap => {
        const loc = snap.val();
        if(loc) passengerDestMarker.setLatLng([loc.latitude, loc.longitude]);
      });
    };

    updateMarkers();
    // Odświeżanie markerów co 2 sekundy
    setInterval(updateMarkers, 2000);
  }
}

// Zapis lokalizacji docelowej pasażera (skrótowe wpisy)
document.getElementById("saveDestinationBtn").addEventListener("click", () => {
  let latSuffix = document.getElementById("destLat").value.trim();
  let lngSuffix = document.getElementById("destLng").value.trim();
  if(latSuffix.length === 3 && lngSuffix.length === 3) {
    const lat = 52.0 + parseInt(latSuffix)/10000;
    const lng = 19.9 + parseInt(lngSuffix)/10000;
    database.ref("session/passenger/destination").set({ latitude: lat, longitude: lng })
      .then(() => console.log("Docelowa lokalizacja passenger zapisana:", lat, lng))
      .catch(err => console.error(err));
  } else {
    alert("Wprowadź dokładnie 3 cyfry dla szerokości i długości!");
  }
});

// Obsługa przycisków
document.getElementById("driverBtn").addEventListener("click", () => assignRole("driver"));
document.getElementById("passengerBtn").addEventListener("click", () => assignRole("passenger"));
</script>
</body>
</html>
