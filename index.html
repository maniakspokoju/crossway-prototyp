<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway â€“ Map 5.5</title>
<style>
  body { font-family: Arial, sans-serif; }
  #roleSelect { margin: 10px 0; }
  #controls { margin-top: 10px; }
  #usersTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
  #usersTable th, #usersTable td { border: 1px solid #000; padding: 5px; text-align: center; }
  #map { width: 360px; height: 360px; border: 1px solid #aaa; margin-top:20px; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
</head>
<body>

																	<h1>Crossway â€“ Map 5.4.3</h1>

<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">PasaÅ¼er</button>
</div>

<div id="controls">
  <button id="prevDriverBtn">â¬… Cofnij</button>
  <button id="nextDriverBtn">âž¡ Dalej</button>
  <button id="acceptBtn">âœ… Akceptuj</button>
  <button id="resetBtn">ðŸ›‘ ZakoÅ„cz przejazd</button>
  <button id="goalBtn">ðŸŽ¯ Edytuj cel</button>
</div>

<div id="assignedPassenger" style="margin-top:10px; font-weight:bold;"></div>

<h2>UÅ¼ytkownicy / trasy</h2>
<table id="usersTable">
  <thead></thead>
  <tbody></tbody>
</table>

<div id="map"></div>

<script>
window.onload = () => {

  // ====== FIREBASE ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "crossway-prototyp",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ====== STANY ======
  let userId=null, userNumber=null, role=null;
  let myColor=null, userLocation=null, myMarker=null;
  let goalEditMode=false, goalMarker=null, routeControl=null;
  let startMarker=null, acceptedDriverId=null;
  let usersData={}, passengersOrder=[], matchedDrivers=[], selectedDriverIndex=0;
  const driverColors={};

  // ====== ELEMENTY ======
  const driverBtn=document.getElementById('driverBtn');
  const passengerBtn=document.getElementById('passengerBtn');
  const prevDriverBtn=document.getElementById('prevDriverBtn');
  const nextDriverBtn=document.getElementById('nextDriverBtn');
  const acceptBtn=document.getElementById('acceptBtn');
  const resetBtn=document.getElementById('resetBtn');
  const goalBtn=document.getElementById('goalBtn');
  const usersTableBody=document.querySelector('#usersTable tbody');
  const usersTableHead=document.querySelector('#usersTable thead');

  // ====== MAPA ======
  const map = L.map('map').setView([52.23,21.01],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'Â© OpenStreetMap' }).addTo(map);

  // ====== FUNKCJE ======
  function getRandomColor(){
    const letters='0123456789ABCDEF';
    let color='#';
    for(let i=0;i<6;i++) color+=letters[Math.floor(Math.random()*16)];
    return color;
  }

  function assignUserNumber(callback){
    db.ref("meta/nextUserNumber").transaction(current => (current||0)+1, (err, committed, snapshot)=>{
      if(committed){
        userNumber=snapshot.val();
        userId=String(userNumber);
        callback();
      }
    });
  }

  function tryCreateMyMarker(){
    if(!map || !userId || !userNumber || !myColor || !userLocation || myMarker) return;

    const icon = L.divIcon({
      className: '',
      html: `<div style="background:${myColor}; color:#fff; width:26px; height:26px; border-radius:50%; text-align:center; line-height:26px; font-weight:bold; border:2px solid #000;">${userNumber}</div>`,
      iconSize: [26,26],
      iconAnchor: [13,13]
    });

    myMarker = L.marker([userLocation.lat,userLocation.lng],{icon}).addTo(map);
    map.setView([userLocation.lat,userLocation.lng],14);
  }

  function getUserLocation(){
    if(!navigator.geolocation){ alert("Brak obsÅ‚ugi GPS"); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude, lng=pos.coords.longitude;
      userLocation={lat,lng};

      if(!startMarker){
        startMarker=L.marker([lat,lng],{color:role==='driver'?driverColors[userId]:'green'}).addTo(map).bindPopup('Start');
      } else {
        startMarker.setLatLng([lat,lng]);
      }

      tryCreateMyMarker();
    }, ()=>alert("Nie udaÅ‚o siÄ™ pobraÄ‡ lokalizacji"));
  }

  function updateUsersHeader(){
    usersTableHead.innerHTML = `<tr><th>#</th><th>Kolor</th>${passengersOrder.map(n=>`<th>${n}</th>`).join('')}</tr>`;
  }

  function passengerOnDriverRoute(p, d){
    if(!p.start || !d.start) return false;
    // uproszczone, moÅ¼esz dopisaÄ‡ logikÄ™ tras
    return true;
  }

  function updateUsersTable(){
    updateUsersHeader();
    usersTableBody.innerHTML='';

    const passengers = Object.values(usersData).filter(u=>u.role==='passenger');
    const drivers = Object.values(usersData).filter(u=>u.role==='driver');

    drivers.forEach(d=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${d.number}</td>
        <td style="background:${d.color||''}"></td>
        ${passengersOrder.map(pn=>{
          const p = passengers.find(x=>x.number===pn);
          return `<td>${p && passengerOnDriverRoute(p,d)?'O':''}</td>`;
        }).join('')}
      `;
      usersTableBody.appendChild(tr);
    });
  }

  function refreshUsers(snapshot){
    usersData = snapshot.val()||{};
    const passengers = Object.values(usersData).filter(u=>u.role==='passenger' && typeof u.number==='number').sort((a,b)=>a.number-b.number);
    passengersOrder = passengers.map(p=>p.number);

    Object.entries(usersData).forEach(([id,u])=>{
      if(u.role==='driver' && !u.color) u.color=getRandomColor();
      if(u.role==='driver') driverColors[id]=u.color;
    });

    updateUsersTable();
  }

  // ====== PRZYCISKI ======
  driverBtn.onclick=()=>{
    role='driver';
    document.body.style.backgroundColor="#ddeeff";
    driverBtn.disabled=true; passengerBtn.disabled=true;
    assignUserNumber(()=>{
      myColor=getRandomColor();
      updateUsersTable();
    });
    getUserLocation();
  };

  passengerBtn.onclick=()=>{
    role='passenger';
    document.body.style.backgroundColor="#ddffdd";
    driverBtn.disabled=true; passengerBtn.disabled=true;
    assignUserNumber(()=>{
      myColor='green';
      updateUsersTable();
    });
    getUserLocation();
  };

  resetBtn.onclick=()=>{
    db.ref("users").remove();
    db.ref("meta").remove();
    usersData={}; passengersOrder=[]; matchedDrivers=[]; selectedDriverIndex=0;
    driverBtn.disabled=false; passengerBtn.disabled=false;
  };

  goalBtn.onclick=()=>{
    goalEditMode=!goalEditMode;
    goalBtn.textContent = goalEditMode ? 'ðŸ’¾ Zapisz cel':'ðŸŽ¯ Edytuj cel';
  };

  db.ref("users").on('value',refreshUsers);

};
</script>

</body>
</html>
