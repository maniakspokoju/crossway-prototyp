<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway â€“ PoÅ‚Ä…czone trasy</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { font-family: Arial; margin:10px;}
#map {height:500px;width:100%;margin-top:10px;}
#controls button {margin:5px; font-size:16px;}
#usersTable {border-collapse:collapse; margin-top:10px; width:100%;}
#usersTable th, #usersTable td {border:1px solid #000; text-align:center; padding:5px;}
</style>
</head>
<body>
<h1>Crossway â€“ PoÅ‚Ä…czone trasy</h1>
<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">PasaÅ¼er</button>
</div>
<div id="controls">
  <button id="prevDriverBtn">â¬… Cofnij</button>
  <button id="nextDriverBtn">âž¡ Dalej</button>
  <button id="acceptBtn">âœ… Akceptuj trasÄ™</button>
  <button id="goalBtn">ðŸŽ¯ Edytuj cel</button>
  <button id="resetBtn">ðŸ›‘ ZakoÅ„cz przejazd</button>
</div>
<div id="assignedPassenger"></div>
<div id="map"></div>
<h2>UÅ¼ytkownicy</h2>
<table id="usersTable">
  <thead><tr><th>ID</th><th>Kolor</th><th>Role</th><th>Akceptowany przez</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== STANY =====
let role=null, userId=null, userNumber=null, myColor=null, userLocation=null;
let gridStart=null, gridEnd=null, goalEditMode=false;
let routeControl=null, driverLine=null, passengerLine=null, overlapLine=null;
let usersData={}, matchedDrivers=[], selectedDriverIndex=0, acceptedDriverId=null;

// ===== ELEMENTY =====
const driverBtn=document.getElementById('driverBtn');
const passengerBtn=document.getElementById('passengerBtn');
const goalBtn=document.getElementById('goalBtn');
const acceptBtn=document.getElementById('acceptBtn');
const prevDriverBtn=document.getElementById('prevDriverBtn');
const nextDriverBtn=document.getElementById('nextDriverBtn');
const resetBtn=document.getElementById('resetBtn');
const usersTableBody=document.querySelector('#usersTable tbody');

// ===== MAPA =====
const map=L.map('map').setView([52.23,21.01],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);

// ===== FUNKCJE POMOCNICZE =====
function getRandomColor(){ const letters='0123456789ABCDEF'; let c='#'; for(let i=0;i<6;i++) c+=letters[Math.floor(Math.random()*16)]; return c;}
function parseCell(str){ const [r,c]=str.split(',').map(Number); return {r,c}; }
function gridToLatLng(cell){ return [52.23+cell.r*0.001,21.01+cell.c*0.001]; }
function distanceMeters(a,b){ const R=6371000,dLat=(b[0]-a[0])*Math.PI/180,dLng=(b[1]-a[1])*Math.PI/180; const x=dLng*Math.cos((a[0]+b[0])/2*Math.PI/180); return Math.sqrt(dLat*dLat+x*x)*R; }
function passengerOnDriverRoute(passenger,driver){
  if(!passenger.start || !driver.start) return false;
  const ps=parseCell(passenger.start), ds=parseCell(driver.start), de=parseCell(driver.end);
  const cells=(ds.r===de.r)?Array.from({length:Math.abs(de.c-ds.c)+1},(_,i)=>({r:ds.r,c:Math.min(ds.c,de.c)+i})):
              Array.from({length:Math.abs(de.r-ds.r)+1},(_,i)=>({r:Math.min(ds.r,de.r)+i,c:ds.c}));
  return cells.some(c=>c.r===ps.r && c.c===ps.c);
}

// ===== PRZYPISANIE NUMERU =====
function assignUserNumber(callback){
  db.ref("meta/nextUserNumber").transaction(n=>(n||0)+1,(err,committed,snap)=>{
    if(committed){ userNumber=snap.val(); userId=String(userNumber); myColor=role==='driver'?getRandomColor():'green';
      db.ref("users/"+userId).set({number:userNumber,role,start:null,end:null,color:myColor,acceptedBy:null});
      if(callback) callback();
    }
  });
}

// ===== POBRANIE LOKALIZACJI =====
function getUserLocation(){
  navigator.geolocation.getCurrentPosition(p=>{
    const lat=p.coords.latitude,lng=p.coords.longitude; userLocation={lat,lng};
    map.setView([lat,lng],14);
  });
}

// ===== RYSOWANIE TRAS =====
function drawRouteOnMap(startLatLng,endLatLng,color){
  if(routeControl) map.removeControl(routeControl);
  routeControl = L.Routing.control({
    waypoints:[L.latLng(startLatLng[0],startLatLng[1]), L.latLng(endLatLng[0],endLatLng[1])],
    lineOptions:{styles:[{color:color,weight:5}]},
    router:L.Routing.osrmv1({serviceUrl:'https://router.project-osrm.org/route/v1',profile:'car'}),
    createMarker:i=>i===0?null:L.marker(routeControl?routeControl._waypoints[i].latLng:null),
    show:false, addWaypoints:false, routeWhileDragging:false, fitSelectedRoutes:true
  }).addTo(map);
}

// ===== UPDATE TRAS PASAÅ»ERA =====
function updateMatchedDrivers(){
  if(role!=='passenger' || !gridStart) return;
  matchedDrivers = Object.entries(usersData)
    .filter(([id,u])=>u.role==='driver' && !u.acceptedBy && u.start && u.end)
    .map(([id,u])=>({id,start:u.start,end:u.end,color:u.color||'blue'}))
    .filter(d=>passengerOnDriverRoute({start:`${gridStart.r},${gridStart.c}`}, d));
  selectedDriverIndex=0;
  updateMapDriverRoute();
}
function updateMapDriverRoute(){
  if(driverLine){ map.removeLayer(driverLine); driverLine=null; }
  if(overlapLine){ map.removeLayer(overlapLine); overlapLine=null; }
  if(!matchedDrivers[selectedDriverIndex]) return;
  const d=matchedDrivers[selectedDriverIndex];
  const startLatLng=gridToLatLng(parseCell(d.start));
  const endLatLng=gridToLatLng(parseCell(d.end));
  driverLine=L.polyline([startLatLng,endLatLng],{color:d.color,weight:5}).addTo(map);
  if(gridEnd){
    const pStart=gridToLatLng(gridStart); const pEnd=gridToLatLng(gridEnd);
    overlapLine=L.polyline([pStart,pEnd,startLatLng,endLatLng],{color:'red',weight:7}).addTo(map);
  }
}

// ===== OBSÅUGA PRZEGLÄ„DANIA KIEROWCÃ“W =====
nextDriverBtn.onclick=()=>{if(matchedDrivers.length===0) return; selectedDriverIndex=(selectedDriverIndex+1)%matchedDrivers.length; updateMapDriverRoute();}
prevDriverBtn.onclick=()=>{if(matchedDrivers.length===0) return; selectedDriverIndex=(selectedDriverIndex-1+matchedDrivers.length)%matchedDrivers.length; updateMapDriverRoute();}

// ===== AKCEPTACJA =====
acceptBtn.onclick=()=>{
  if(matchedDrivers[selectedDriverIndex]){
    acceptedDriverId = matchedDrivers[selectedDriverIndex].id;
    db.ref(`users/${userId}/acceptedBy`).set(acceptedDriverId);
    db.ref(`users/${acceptedDriverId}/acceptedBy`).set(userId);
    updateMapDriverRoute();
  }
}

// ===== EDYCJA CELU =====
goalBtn.onclick=()=>{goalEditMode=!goalEditMode; goalBtn.textContent = goalEditMode ? 'ðŸ’¾ Zapisz cel' : 'ðŸŽ¯ Edytuj cel';}

// ===== RESET =====
resetBtn.onclick=()=>{
  db.ref("users").remove(); db.ref("meta").remove();
  gridStart=null; gridEnd=null; usersData={}; matchedDrivers=[]; selectedDriverIndex=0; acceptedDriverId=null;
}

// ===== TABELA UÅ»YTKOWNIKÃ“W =====
function updateUsersTable(){
  usersTableBody.innerHTML='';
  Object.values(usersData).forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${u.number}</td><td style="background:${u.color}"></td><td>${u.role}</td><td>${u.acceptedBy||''}</td>`;
    usersTableBody.appendChild(tr);
  });
}

// ===== OBSÅUGA FIREBASE =====
db.ref("users").on('value',snap=>{
  usersData=snap.val()||{};
  updateUsersTable();
  updateMatchedDrivers();
});

// ===== PRZYPISANIE ROLI =====
driverBtn.onclick=()=>{role='driver'; driverBtn.disabled=true; passengerBtn.disabled=true; assignUserNumber(getUserLocation);}
passengerBtn.onclick=()=>{role='passenger'; driverBtn.disabled=true; passengerBtn.disabled=true; assignUserNumber(getUserLocation);}
</script>
</body>
</html>
