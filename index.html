<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
    font-family: sans-serif;
    margin: 10px;
}

/* MAPA */
#map {
    height: 1000px;
    margin-top: 20px;
    display: none;
}

/* SEKCJE FORMULARZY */
#driverDestinationDiv,
#passengerDestinationDiv {
    display: none;
    margin-top: 20px;
}

/* INPUTY */
input {
    width: 120px;
    height: 50px;
    font-size: 22px;
    margin-right: 10px;
    text-align: center;
}

/* ===== DUŻE PRZYCISKI (4–6x) ===== */
button {
    font-size: 26px;
    padding: 20px 30px;
    margin: 10px 5px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
}

/* LEPSZA CZYTELNOŚĆ RÓL */
#driverBtn {
    background-color: #2f6fff;
    color: white;
}

#passengerBtn {
    background-color: #2fbf6f;
    color: white;
}

/* EFEKT DOTYKOWY */
button:active {
    transform: scale(0.97);
}
</style>
</head>

<body>
																	<h1>Crossway – fundament 1.8</h1>

<button id="driverBtn">Driver</button>
<button id="passengerBtn">Passenger</button>
<p id="role"></p>

<div id="driverDestinationDiv">
<h3>Cel kierowcy</h3>
<input id="driverDestLat" placeholder="###" step="1" inputmode="numeric">
<input id="driverDestLng" placeholder="###" step="1" inputmode="numeric">
<button id="saveDriverDestinationBtn">Zapisz</button>
</div>

<div id="passengerDestinationDiv">
<h3>Cel pasażera</h3>
<input id="destLat" placeholder="###" step="1" inputmode="numeric">
<input id="destLng" placeholder="###" step="1" inputmode="numeric">
<button id="saveDestinationBtn">Zapisz</button>
</div>

<div id="passengerStartDiv" style="margin-top:15px; display:none;">
  <h3>Start pasażera (zmiana dla testów)</h3>
  <input type="number" id="startLat" placeholder="###" step="1" inputmode="numeric">
  <input type="number" id="startLng" placeholder="###" step="1" inputmode="numeric">
  <button id="saveStartBtn">Zapisz start</button>
  <p style="font-size:14px; color:gray;">Wpisz dokładnie 3 cyfry: 52.1### / 19.9###</p>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();
db.ref("session").remove();

/* ================= MAP ================= */
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const driverLine = L.polyline([], { color: "blue", weight: 5 }).addTo(map);
const passengerLine = L.polyline([], { color: "green", weight: 5 }).addTo(map);
const overlapLine = L.polyline([], { color: "red", weight: 7 }).addTo(map);

/* ================= MARKERY ================= */

// Ikony liter K i P
const iconK = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2f6fff'>K</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

const iconP = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2fbf6f'>P</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

// Markery
const driverStartMarker = L.marker([0,0], { icon: iconK }).addTo(map);
const passengerStartMarker = L.marker([0,0], { icon: iconP }).addTo(map);

const driverEndMarker = L.marker([0,0]).addTo(map);
const passengerEndMarker = L.marker([0,0]).addTo(map);


/* ================= UTILS ================= */
const TOLERANCE_METERS = 30;

function distanceMeters(a, b) {
  const R = 6371000;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLng = (b[1]-a[1]) * Math.PI/180;
  const x = dLng * Math.cos((a[0]+b[0])/2 * Math.PI/180);
  return Math.sqrt(dLat*dLat + x*x) * R;
}

function findClosestIndex(point, path) {
  let min = Infinity, idx = -1;
  path.forEach((p, i) => {
    const d = distanceMeters(point, p);
    if (d < min) { min = d; idx = i; }
  });
  return min <= TOLERANCE_METERS ? idx : -1;
}

/* ================= OSRM ================= */
async function route(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

/* ================= MAIN ================= */
async function update() {
  overlapLine.setLatLngs([]);

  const ds = (await db.ref("session/driver").once("value")).val();
  const ps = (await db.ref("session/passenger").once("value")).val();
  if(!ds?.currentLocation || !ds?.destination || !ps?.currentLocation || !ps?.destination) return;

  const dPath = await route(
    [ds.currentLocation.latitude, ds.currentLocation.longitude],
    [ds.destination.latitude, ds.destination.longitude]
    "driving"
  );

  const pPath = await route(
    [ps.currentLocation.latitude, ps.currentLocation.longitude],
    [ps.destination.latitude, ps.destination.longitude]
    "walking"
  );

  driverLine.setLatLngs(dPath);
  passengerLine.setLatLngs(pPath);

/* ===== STARTY ===== */
driverStartMarker.setLatLng(dPath[0]);
passengerStartMarker.setLatLng(pPath[0]);

/* ===== CELE ===== */
driverEndMarker.setLatLng(dPath[dPath.length - 1]);
passengerEndMarker.setLatLng(pPath[pPath.length - 1]);


  const startPassenger = [ps.currentLocation.latitude, ps.currentLocation.longitude];
  const startIdx = findClosestIndex(startPassenger, dPath);
  if(startIdx === -1) return;

  const intersections = [];
  dPath.forEach((dp,i)=>{
    pPath.forEach(pp=>{
      if(distanceMeters(dp,pp) <= TOLERANCE_METERS) intersections.push(i);
    });
  });

  const unique = [...new Set(intersections)].filter(i=>i>=startIdx);
  if(unique.length < 2) return;

  const endIdx = Math.max(...unique);
  overlapLine.setLatLngs(dPath.slice(startIdx, endIdx+1));
}

db.ref("session").on("value", () => {
  update();
  updateRoleAvailability();
});


/* ================= ROLE ================= */
function assign(role) {
  document.getElementById("map").style.display = "block";
  db.ref("session/"+role).set({ role });
  navigator.geolocation.getCurrentPosition(p=>{
    db.ref(`session/${role}/currentLocation`).set({
      latitude: p.coords.latitude,
      longitude: p.coords.longitude
    });
  });
  if(role==="driver") driverDestinationDiv.style.display="block";
  if(role==="passenger") passengerDestinationDiv.style.display="block";
if(role==="passenger") passengerStartDiv.style.display="block";

}

driverBtn.onclick = ()=>assign("driver");
passengerBtn.onclick = ()=>assign("passenger");

/* ================= BLOKADA RÓL ================= */

function updateRoleAvailability() {
  db.ref("session").once("value").then(snapshot => {
    const data = snapshot.val() || {};

    // DRIVER
    if (data.driver && data.driver.role === "driver") {
      driverBtn.disabled = true;
      driverBtn.style.opacity = "0.4";
      driverBtn.innerText = "Driver zajęty";
    } else {
      driverBtn.disabled = false;
      driverBtn.style.opacity = "1";
      driverBtn.innerText = "Driver";
    }

    // PASSENGER
    if (data.passenger && data.passenger.role === "passenger") {
      passengerBtn.disabled = true;
      passengerBtn.style.opacity = "0.4";
      passengerBtn.innerText = "Passenger zajęty";
    } else {
      passengerBtn.disabled = false;
      passengerBtn.style.opacity = "1";
      passengerBtn.innerText = "Passenger";
    }
  });
}


/* ================= DEST ================= */
saveDriverDestinationBtn.onclick = ()=>{
  db.ref("session/driver/destination").set({
    latitude: 52.1 + driverDestLat.value/10000,
    longitude: 19.9 + driverDestLng.value/10000
  });
};

saveDestinationBtn.onclick = ()=>{
  db.ref("session/passenger/destination").set({
    latitude: 52.1 + destLat.value/10000,
    longitude: 19.9 + destLng.value/10000
  });
};

// ===================== ZMIANA STARTU PASAŻERA =====================
saveStartBtn.addEventListener("click", () => {
  const latSuffix = startLat.value.trim();
  const lngSuffix = startLng.value.trim();

  if(latSuffix.length === 3 && lngSuffix.length === 3){
    const lat = 52.1 + parseInt(latSuffix)/10000;
    const lng = 19.9 + parseInt(lngSuffix)/10000;

    db.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng })
      .then(() => console.log("Nowa lokalizacja startowa pasażera zapisana:", lat, lng))
      .catch(err => console.error(err));
  } else {
    alert("Wprowadź dokładnie 3 cyfry dla szerokości i długości!");
  }
});

</script>
</body>
</html>
