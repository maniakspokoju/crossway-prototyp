<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Crossway – prototyp</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
html, body {
  margin: 0;
  height: 100%;
  background: #111;
  color: #fff;
  font-family: sans-serif;
}

#map {
  height: 100%;
}

.panel {
  position: absolute;
  top: 10px;
  left: 10px;
  background: #1e1e1e;
  padding: 10px;
  border-radius: 8px;
  z-index: 1000;
}

button {
  display: block;
  margin-bottom: 6px;
  padding: 6px 10px;
  width: 120px;
}
</style>
</head>

<body>

<div class="panel">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">Pasażer</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();

/* ================= MAP ================= */
const map = L.map("map").setView([52.12, 19.95], 10);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

/* ================= STATE ================= */
let currentRole = null;
let routeLayer = null;

/* ================= MARKERS ================= */
const driverMarker = L.marker([0,0]);
const passengerMarker = L.marker([0,0]);

/* ================= ROLE ================= */
function assignRole(role) {
  if (currentRole) return; // ❗ BLOKADA zmiany roli

  currentRole = role;

  document.body.style.background =
    role === "driver" ? "#102020" : "#201020";

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    db.ref("session/" + role + "/currentLocation").set({ latitude: lat, longitude: lng });
    db.ref("session/" + role + "/role").set(role);

    const marker = role === "driver" ? driverMarker : passengerMarker;
    marker.setLatLng([lat, lng]).addTo(map);

    map.setView([lat, lng], 13);
  });
}

/* ================= ROUTE ================= */
function drawRoute(a, b) {
  if (routeLayer) map.removeLayer(routeLayer);

  fetch(
    `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`
  )
  .then(r => r.json())
  .then(data => {
    routeLayer = L.geoJSON(data.routes[0].geometry, {
      style: { weight: 5 }
    }).addTo(map);
  })
  .catch(() => console.warn("OSRM timeout"));
}

/* ================= DB LISTENERS ================= */
db.ref("session").on("value", snap => {
  const s = snap.val();
  if (!s?.driver || !s?.passenger) return;

  const d = s.driver.currentLocation;
  const p = s.passenger.currentLocation;

  driverMarker.setLatLng([d.latitude, d.longitude]).addTo(map);
  passengerMarker.setLatLng([p.latitude, p.longitude]).addTo(map);

  drawRoute(
    { lat: d.latitude, lng: d.longitude },
    { lat: p.latitude, lng: p.longitude }
  );
});

/* ================= UI ================= */
driverBtn.onclick = () => assignRole("driver");
passengerBtn.onclick = () => assignRole("passenger");
</script>

</body>
</html>
