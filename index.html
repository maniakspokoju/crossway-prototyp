<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Crossway – Multiuser</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body { font-family: sans-serif; margin: 10px; transition: background-color 0.3s ease; }
#map { height: 60vh; margin-top: 20px; }
button { font-size: 20px; padding: 10px 15px; margin: 5px; border-radius: 10px; cursor: pointer; }
button:active { transform: scale(0.97); }
#roleBar { display: flex; width: 100%; }
#roleBar button { flex:1; height: 60px; font-size: 22px; border-radius: 0; }
#passengerControls { display:none; margin-top:10px; }
#passengerControls button { font-size: 18px; padding: 10px; border-radius: 8px; }
#tableWrapper { margin-top:20px; overflow-x:auto; }
table { border-collapse: collapse; width: 100%; }
th, td { border: 1px solid #000; padding:5px; text-align:center; }
</style>
</head>
<body>
<h1>Crossway – Multiuser 5.0</h1>

<div id="roleBar">
  <button id="driverBtn">Driver</button>
  <button id="passengerBtn">Passenger</button>
</div>

<div id="passengerControls">
  <button id="modeBtn">Tryb A</button>
  <button id="acceptBtn" style="background:#ff5722;color:white;" disabled>Akceptuj trasę</button>
  <button id="prevDriverBtn">◀</button>
  <button id="nextDriverBtn">▶</button>
  <button id="saveDestinationBtn">Edytuj cel</button>
  <button id="saveStartBtn">Edytuj start</button>
</div>

<div id="driverDestinationDiv">
  <button id="saveDriverDestinationBtn">Edytuj cel</button>
</div>

<div id="map"></div>

<div id="tableWrapper">
  <table id="usersTable">
    <thead><tr id="usersTableHeader"><th>Kierowcy / Pasażerowie</th></tr></thead>
    <tbody id="usersTableBody"></tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();

// ================= GLOBAL =================
let currentRole = null;
let currentMode = "A";
let selectedPoint = null;
let editingDriverDestination = false;
let editingPassengerDestination = false;
let editingPassengerStart = false;
let acceptLocked = false;
let accepted = false;

// ================= MAP =================
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ================= ICONY =================
function createIcon(letter, color) {
  return L.divIcon({html:`<div style="font-size:20px;font-weight:bold;color:${color}">${letter}</div>`, className:"", iconSize:[30,30], iconAnchor:[15,15]});
}

// ================= KOLORY =================
function randomColor() {
  const letters = '0123456789ABCDEF';
  let c = '#';
  for (let i=0;i<6;i++) c+=letters[Math.floor(Math.random()*16)];
  return c;
}

// ================= USERS DATA =================
let usersData = { drivers:{}, passengers:{} }; // local cache
let passengerDriverIndex = 0;

// ================= UTILS =================
function distanceMeters(a,b){const R=6371000;const dLat=(b[0]-a[0])*Math.PI/180;const dLng=(b[1]-a[1])*Math.PI/180;const x=dLng*Math.cos((a[0]+b[0])/2*Math.PI/180);return Math.sqrt(dLat*dLat+x*x)*R;}
function findClosestIndex(point,path){let min=Infinity,idx=-1;path.forEach((p,i)=>{const d=distanceMeters(point,p);if(d<min){min=d;idx=i;}});return min<=60?idx:-1;}
function findBestExitIndex(driverPath,passengerDestination,startIdx){let bestIdx=startIdx,bestDistance=Infinity;for(let i=startIdx;i<driverPath.length;i++){const d=distanceMeters(driverPath[i],passengerDestination);if(d<bestDistance){bestDistance=d;bestIdx=i;}}return bestIdx;}

// ================= MAP MARKERS =================
let driverMarkers = {};
let passengerMarkers = {};
let driverLines = {};
let passengerLines = {};
let overlapLine = L.polyline([], {color:"red", weight:7, dashArray:"5,5"}).addTo(map);

// ================= FIREBASE LISTENERS =================
db.ref("session").on("value", snap=>{
  const data = snap.val()||{};
  usersData = data;
  updateTable();
  updateMap();
  updateRoleAvailability();
});

// ================= TABLE =================
function updateTable(){
  const header = document.getElementById("usersTableHeader");
  const body = document.getElementById("usersTableBody");
  // Header
  header.innerHTML = '<th>Kierowcy / Pasażerowie</th>';
  for(const pid in usersData.passengers) header.innerHTML+=`<th>${pid}</th>`;
  // Body
  body.innerHTML="";
  for(const did in usersData.drivers){
    const row = document.createElement("tr");
    row.innerHTML=`<th>${did}</th>`;
    for(const pid in usersData.passengers){
      const overlap = checkOverlap(usersData.drivers[did], usersData.passengers[pid]);
      row.innerHTML+=`<td style="background:${overlap? 'red':'white'}">${overlap? '●':''}</td>`;
    }
    body.appendChild(row);
  }
}

// ================= CHECK OVERLAP =================
function checkOverlap(driver, passenger){
  if(!driver?.destination||!driver?.currentLocation||!passenger?.currentLocation||!passenger?.destination) return false;
  const dPath = driver.path;
  const startIdx = findClosestIndex([passenger.currentLocation.latitude,passenger.currentLocation.longitude],dPath||[]);
  return startIdx!==-1;
}

// ================= MAP UPDATE =================
async function updateMap(){
  // Clear previous
  Object.values(driverLines).forEach(l=>map.removeLayer(l));
  Object.values(passengerLines).forEach(l=>map.removeLayer(l));
  Object.values(driverMarkers).forEach(m=>map.removeLayer(m));
  Object.values(passengerMarkers).forEach(m=>map.removeLayer(m));

  // Draw drivers
  driverLines={}; driverMarkers={};
  for(const did in usersData.drivers){
    const d = usersData.drivers[did];
    if(d?.currentLocation&&d?.destination){
      d.path = await route([d.currentLocation.latitude,d.currentLocation.longitude],[d.destination.latitude,d.destination.longitude]);
      const color = d.color||randomColor(); d.color=color;
      driverLines[did]=L.polyline(d.path,{color:color,weight:5}).addTo(map);
      driverMarkers[did]=L.marker(d.path[0],{icon:createIcon('K',color)}).addTo(map);
    }
  }
  // Draw passengers
  passengerLines={}; passengerMarkers={};
  const passengerKeys = Object.keys(usersData.passengers);
  if(passengerKeys.length){
    const pid = passengerKeys[passengerDriverIndex%passengerKeys.length];
    const passenger = usersData.passengers[pid];
    if(passenger?.currentLocation&&passenger?.destination){
      passenger.path = await route([passenger.currentLocation.latitude,passenger.currentLocation.longitude],[passenger.destination.latitude,passenger.destination.longitude]);
      const color = passenger.color||randomColor(); passenger.color=color;
      passengerLines[pid]=L.polyline(passenger.path,{color:color,weight:5}).addTo(map);
      passengerMarkers[pid]=L.marker(passenger.path[0],{icon:createIcon('P',color)}).addTo(map);

      // show driver overlap only
      for(const did in usersData.drivers){
        if(checkOverlap(usersData.drivers[did], passenger)){
          overlapLine.setLatLngs(usersData.drivers[did].path.slice(findClosestIndex([passenger.currentLocation.latitude,passenger.currentLocation.longitude],usersData.drivers[did].path)));
        }
      }
    }
  }
}

// ================= ROUTING =================
async function route(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

// ================= ROLE ASSIGN =================
function assign(role){
  currentRole=role;
  navigator.geolocation.getCurrentPosition(p=>{
    const lat=p.coords.latitude,lng=p.coords.longitude;
    const newData={currentLocation:{latitude:lat,longitude:lng}};
    db.ref(`session/${role==='driver'?'drivers':'passengers'}/${role==='driver'?'driver'+Date.now():'passenger'+Date.now()}`).update(newData);
  });
  if(role==='driver') document.getElementById("driverDestinationDiv").style.display="block";
  if(role==='passenger') document.getElementById("passengerControls").style.display="block";
  updateRoleAvailability();
}

// ================= BUTTONS =================
document.getElementById("driverBtn").onclick=()=>assign("driver");
document.getElementById("passengerBtn").onclick=()=>assign("passenger");

document.getElementById("prevDriverBtn").onclick=()=>{passengerDriverIndex=(passengerDriverIndex-1+Object.keys(usersData.passengers).length)%Object.keys(usersData.passengers).length; updateMap();};
document.getElementById("nextDriverBtn").onclick=()=>{passengerDriverIndex=(passengerDriverIndex+1)%Object.keys(usersData.passengers).length; updateMap();};

document.getElementById("modeBtn").onclick=()=>{
  currentMode=currentMode==="A"?"B":"A";
  db.ref("session/mode").set(currentMode);
};

db.ref("session/mode").on("value", snap=>{currentMode=snap.val()||"A"; document.getElementById("modeBtn").innerText="Tryb "+currentMode; updateMap();});

// ================= EDIT DESTINATION/START =================
const saveDriverDestinationBtn = document.getElementById("saveDriverDestinationBtn");
const saveDestinationBtn = document.getElementById("saveDestinationBtn");
const saveStartBtn = document.getElementById("saveStartBtn");
let selectedPointMarker=null;

map.on('click', e=>{selectedPoint=[e.latlng.lat,e.latlng.lng]; if(editingDriverDestination||editingPassengerDestination||editingPassengerStart){if(selectedPointMarker) map.removeLayer(selectedPointMarker); selectedPointMarker=L.marker([e.latlng.lat,e.latlng.lng]).addTo(map);}});

saveDriverDestinationBtn.onclick=()=>{
  if(!editingDriverDestination){editingDriverDestination=true; saveDriverDestinationBtn.innerText="Zapisz cel"; return;}
  if(selectedPoint){ const did=Object.keys(usersData.drivers)[0]; db.ref(`session/drivers/${did}/destination`).set({latitude:selectedPoint[0],longitude:selectedPoint[1]}); }
  editingDriverDestination=false; saveDriverDestinationBtn.innerText="Edytuj cel"; if(selectedPointMarker) map.removeLayer(selectedPointMarker); selectedPoint=null;
};

saveDestinationBtn.onclick=()=>{
  if(!editingPassengerDestination){editingPassengerDestination=true; saveDestinationBtn.innerText="Zapisz cel"; return;}
  if(selectedPoint){ const pid=Object.keys(usersData.passengers)[0]; db.ref(`session/passengers/${pid}/destination`).set({latitude:selectedPoint[0],longitude:selectedPoint[1]}); }
  editingPassengerDestination=false; saveDestinationBtn.innerText="Edytuj cel"; if(selectedPointMarker) map.removeLayer(selectedPointMarker); selectedPoint=null;
};

saveStartBtn.onclick=()=>{
  if(!editingPassengerStart){editingPassengerStart=true; saveStartBtn.innerText="Zapisz start"; return;}
  if(selectedPoint){ const pid=Object.keys(usersData.passengers)[0]; db.ref(`session/passengers/${pid}/currentLocation`).set({latitude:selectedPoint[0],longitude:selectedPoint[1]}); }
  editingPassengerStart=false; saveStartBtn.innerText="Edytuj start"; if(selectedPointMarker) map.removeLayer(selectedPointMarker); selectedPoint=null;
};

// ================= ACCEPT =================
const acceptBtn = document.getElementById("acceptBtn");
acceptBtn.onclick=()=>{
  if(acceptLocked) return; acceptLocked=true;
  const pid=Object.keys(usersData.passengers)[0];
  db.ref(`session/passengers/${pid}/accepted`).set(true);
  acceptBtn.disabled=true; acceptBtn.style.opacity="0.4";
};

// ================= ROLE AVAILABILITY =================
function updateRoleAvailability(){
  const driverBtn = document.getElementById("driverBtn");
  const passengerBtn = document.getElementById("passengerBtn");
  driverBtn.disabled = currentRole==="driver"; passengerBtn.disabled = currentRole==="passenger";
}
</script>
</body>
</html>
