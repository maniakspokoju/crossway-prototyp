<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
    font-family: sans-serif;
    margin: 10px;
}

/* MAPA */
#map {
    height: 1000px;
    margin-top: 20px;
    display: none;
}

/* SEKCJE FORMULARZY */
#driverDestinationDiv,
#passengerDestinationDiv {
    display: none;
    margin-top: 20px;
}

/* INPUTY */
input {
    width: 120px;
    height: 50px;
    font-size: 22px;
    margin-right: 10px;
    text-align: center;
}

/* ===== DUŻE PRZYCISKI (4–6x) ===== */
button {
    font-size: 26px;
    padding: 20px 30px;
    margin: 10px 5px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
}

/* LEPSZA CZYTELNOŚĆ RÓL */
#driverBtn {
    background-color: #2f6fff;
    color: white;
}

#passengerBtn {
    background-color: #2fbf6f;
    color: white;
}

/* EFEKT DOTYKOWY */
button:active {
    transform: scale(0.97);
}
</style>
</head>

<body>
<h1>Crossway – fundament 1.2</h1>

<button id="driverBtn">Driver</button>
<button id="passengerBtn">Passenger</button>
<p id="role"></p>

<div id="driverDestinationDiv">
<h3>Cel kierowcy</h3>
<input id="driverDestLat" placeholder="###">
<input id="driverDestLng" placeholder="###">
<button id="saveDriverDestinationBtn">Zapisz</button>
</div>

<div id="passengerDestinationDiv">
<h3>Cel pasażera</h3>
<input id="destLat" placeholder="###">
<input id="destLng" placeholder="###">
<button id="saveDestinationBtn">Zapisz</button>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();
db.ref("session").remove();

/* ================= MAP ================= */
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const driverLine = L.polyline([], { color: "blue", weight: 5 }).addTo(map);
const passengerLine = L.polyline([], { color: "green", weight: 5 }).addTo(map);
const overlapLine = L.polyline([], { color: "red", weight: 7 }).addTo(map);

/* ================= UTILS ================= */
const TOLERANCE_METERS = 30;

function distanceMeters(a, b) {
  const R = 6371000;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLng = (b[1]-a[1]) * Math.PI/180;
  const x = dLng * Math.cos((a[0]+b[0])/2 * Math.PI/180);
  return Math.sqrt(dLat*dLat + x*x) * R;
}

function findClosestIndex(point, path) {
  let min = Infinity, idx = -1;
  path.forEach((p, i) => {
    const d = distanceMeters(point, p);
    if (d < min) { min = d; idx = i; }
  });
  return min <= TOLERANCE_METERS ? idx : -1;
}

/* ================= OSRM ================= */
async function route(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

/* ================= MAIN ================= */
async function update() {
  overlapLine.setLatLngs([]);

  const ds = (await db.ref("session/driver").once("value")).val();
  const ps = (await db.ref("session/passenger").once("value")).val();
  if(!ds?.currentLocation || !ds?.destination || !ps?.currentLocation || !ps?.destination) return;

  const dPath = await route(
    [ds.currentLocation.latitude, ds.currentLocation.longitude],
    [ds.destination.latitude, ds.destination.longitude]
  );

  const pPath = await route(
    [ps.currentLocation.latitude, ps.currentLocation.longitude],
    [ps.destination.latitude, ps.destination.longitude]
  );

  driverLine.setLatLngs(dPath);
  passengerLine.setLatLngs(pPath);

  const startPassenger = [ps.currentLocation.latitude, ps.currentLocation.longitude];
  const startIdx = findClosestIndex(startPassenger, dPath);
  if(startIdx === -1) return;

  const intersections = [];
  dPath.forEach((dp,i)=>{
    pPath.forEach(pp=>{
      if(distanceMeters(dp,pp) <= TOLERANCE_METERS) intersections.push(i);
    });
  });

  const unique = [...new Set(intersections)].filter(i=>i>=startIdx);
  if(unique.length < 2) return;

  const endIdx = Math.max(...unique);
  overlapLine.setLatLngs(dPath.slice(startIdx, endIdx+1));
}

db.ref("session").on("value", update);

/* ================= ROLE ================= */
function assign(role) {
  document.getElementById("map").style.display = "block";
  db.ref("session/"+role).set({ role });
  navigator.geolocation.getCurrentPosition(p=>{
    db.ref(`session/${role}/currentLocation`).set({
      latitude: p.coords.latitude,
      longitude: p.coords.longitude
    });
  });
  if(role==="driver") driverDestinationDiv.style.display="block";
  if(role==="passenger") passengerDestinationDiv.style.display="block";
}

driverBtn.onclick = ()=>assign("driver");
passengerBtn.onclick = ()=>assign("passenger");

/* ================= DEST ================= */
saveDriverDestinationBtn.onclick = ()=>{
  db.ref("session/driver/destination").set({
    latitude: 52.1 + driverDestLat.value/10000,
    longitude: 19.9 + driverDestLng.value/10000
  });
};

saveDestinationBtn.onclick = ()=>{
  db.ref("session/passenger/destination").set({
    latitude: 52.1 + destLat.value/10000,
    longitude: 19.9 + destLng.value/10000
  });
};
</script>
</body>
</html>
