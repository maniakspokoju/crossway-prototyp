<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Crossway</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
    font-family: sans-serif;
    margin: 10px;
}

/* MAPA */
#map {
    height: 1000px;
    margin-top: 20px;
}

/* SEKCJE FORMULARZY */
#driverDestinationDiv,
#passengerDestinationDiv {
    display: none;
    margin-top: 20px;
}

/* INPUTY */
input {
    width: 120px;
    height: 50px;
    font-size: 22px;
    margin-right: 10px;
    text-align: center;
}

/* ===== DUÅ»E PRZYCISKI (4â€“6x) ===== */
button {
    font-size: 26px;
    padding: 20px 30px;
    margin: 10px 5px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
}

/* LEPSZA CZYTELNOÅšÄ† RÃ“L */
#driverBtn {
    background-color: #2f6fff;
    color: white;
}

#passengerBtn {
    background-color: #2fbf6f;
    color: white;
}

/* EFEKT DOTYKOWY */
button:active {
    transform: scale(0.97);
}

/* ===== MOBILE LAYOUT ===== */
html, body {
  height: 100%;
  margin: 0;
}

#roleBar {
  display: flex;
  width: 100%;
}

#roleBar button {
  width: 50%;
  height: 80px;
  font-size: 28px;
  border-radius: 0;
}

/* MAPA ZAWSZE NA DOLE */
#map {
  height: calc(100vh - 80px);
}

</style>
</head>

<body>
																<h1>Crossway â€“ fundament 3.7</h1>

<div id="roleBar">
  <button id="driverBtn">Driver</button>
  <button id="passengerBtn">Passenger</button>
</div>

<p id="role"></p>
<button id="modeBtn" style="display:none;">Tryb A</button>

<button id="acceptBtn" style="display:none; background:#ff5722; color:white;">
  Akceptuj trasÄ™
</button>


<div id="driverDestinationDiv">
<h3>Cel kierowcy</h3>

<!-- <input id="driverDestLat" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->
<!-- <input id="driverDestLng" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->

<button id="saveDriverDestinationBtn">Edytuj cel</button>
</div>

<div id="passengerDestinationDiv">
<h3>Cel pasaÅ¼era</h3>

<!-- <input id="destLat" placeholder="###" step="1" inputmode="numeric"> -->			<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->
<!-- <input id="destLng" placeholder="###" step="1" inputmode="numeric"> -->			<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->

<button id="saveDestinationBtn">Edytuj cel</button>
</div>

<div id="passengerStartDiv" style="margin-top:15px; display:none;">
  <h3>Start pasaÅ¼era (zmiana dla testÃ³w)</h3>

<!-- <input type="number" id="startLat" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->
<!-- <input type="number" id="startLng" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->

  <button id="saveStartBtn">Edytuj start</button>
  </div>

<div id="savedLocations" style="margin-top:10px; font-weight:bold;">
  <p id="driverSavedInfo" style="color:#2f6fff;"></p>
  <p id="passengerSavedInfo" style="color:#2fbf6f;"></p>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>


function showStartMarker(role, lat, lng) {
  const latlng = [lat, lng];
  if (role === "driver") {
    driverStartMarker.setLatLng(latlng); // pokaÅ¼ D
  } 
  if (role === "passenger") {
    passengerStartMarker.setLatLng(latlng); // pokaÅ¼ P
  }
}



/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();
db.ref("session").remove();

let currentMode = "A"; // A = przeciÄ™cia, B = optymalny dystans
let accepted = false;

let currentRole = null; // "driver" | "passenger"

// STANY EDYCJI
let editingDriverDestination = false;
let editingPassengerDestination = false;
let editingPassengerStart = false;

// Zmienna przechowujÄ…ca wybrany punkt z mapy
let selectedPoint = null;


/* ================= MAP ================= */
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const driverLine = L.polyline([], { color: "blue", weight: 5 }).addTo(map);
const passengerLine = L.polyline([], { color: "green", weight: 5 }).addTo(map);
const overlapLine = L.polyline([], { color: "red", weight: 7 }).addTo(map);

/* ================= MARKERY ================= */

// Ikony liter K i P
const iconK = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2f6fff'>K</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

const iconP = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2fbf6f'>P</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

// Markery
const driverStartMarker = L.marker([0,0], { icon: iconK }).addTo(map);
const passengerStartMarker = L.marker([0,0], { icon: iconP }).addTo(map);

const driverEndMarker = L.marker([0,0]).addTo(map);
const passengerEndMarker = L.marker([0,0]).addTo(map);


/* ================= UTILS ================= */
const TOLERANCE_METERS = 30;

function distanceMeters(a, b) {
  const R = 6371000;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLng = (b[1]-a[1]) * Math.PI/180;
  const x = dLng * Math.cos((a[0]+b[0])/2 * Math.PI/180);
  return Math.sqrt(dLat*dLat + x*x) * R;
}

function findClosestIndex(point, path) {
  let min = Infinity, idx = -1;
  path.forEach((p, i) => {
    const d = distanceMeters(point, p);
    if (d < min) { min = d; idx = i; }
  });
  return min <= TOLERANCE_METERS ? idx : -1;
}

// ObsÅ‚uga klikniÄ™cia na mapie
map.on('click', function(e) {
  // JeÅ›li Å¼aden tryb edycji nie jest aktywny, nic nie rÃ³b
  if (!editingDriverDestination && !editingPassengerDestination && !editingPassengerStart) return;

  // Zapisujemy klikniÄ™ty punkt
  selectedPoint = [e.latlng.lat, e.latlng.lng];

  // PodglÄ…d znacznika na mapie
  if (editingDriverDestination) driverEndMarker.setLatLng(selectedPoint);
  if (editingPassengerDestination) passengerEndMarker.setLatLng(selectedPoint);
  if (editingPassengerStart) passengerStartMarker.setLatLng(selectedPoint);
});


function findBestExitIndex(driverPath, passengerDestination, startIdx) {
  let bestIdx = startIdx;
  let bestDistance = Infinity;

  for (let i = startIdx; i < driverPath.length; i++) {
    const d = distanceMeters(driverPath[i], passengerDestination);
    if (d < bestDistance) {
      bestDistance = d;
      bestIdx = i;
    }
  }

  return bestIdx;
}


/* ================= OSRM ================= */
async function route(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

db.ref("session/accepted").on("value", snap => {
  accepted = snap.val() === true;
  if (accepted) lockFormsAfterAccept();
});





/* ================= MAIN ================= */
async function update() {
  // czyÅ›cimy linie (bez ruszania mapy)
  driverLine.setLatLngs([]);
  passengerLine.setLatLngs([]);
  overlapLine.setLatLngs([]);

  const ds = (await db.ref("session/driver").once("value")).val();
  const ps = (await db.ref("session/passenger").once("value")).val();

  let dPath = null;
  let pPath = null;

  /* ================= TRASA KIEROWCY (ZAWSZE) ================= */
  if (ds?.currentLocation && ds?.destination) {
    dPath = await route(
      [ds.currentLocation.latitude, ds.currentLocation.longitude],
      [ds.destination.latitude, ds.destination.longitude]
    );

    driverLine.setLatLngs(dPath);

    if (dPath.length) {
      driverStartMarker.setLatLng(dPath[0]);
      driverEndMarker.setLatLng(dPath.at(-1));
    }
  }

  /* ================= TRASA PASAÅ»ERA ================= */
  if (
    ps?.currentLocation &&
    ps?.destination &&
    (accepted || currentRole === "passenger")
  ) {
    pPath = await route(
      [ps.currentLocation.latitude, ps.currentLocation.longitude],
      [ps.destination.latitude, ps.destination.longitude]
    );

    passengerLine.setLatLngs(pPath);

    if (pPath.length) {
      passengerStartMarker.setLatLng(pPath[0]);
      passengerEndMarker.setLatLng(pPath.at(-1));
    }
  }

  /* ================= TRASA WSPÃ“LNA ================= */
  if (dPath && pPath) {
    const startPassenger = [
      ps.currentLocation.latitude,
      ps.currentLocation.longitude
    ];

    const startIdx = findClosestIndex(startPassenger, dPath);
    if (startIdx === -1) return;

    let endIdx = -1;

    if (currentMode === "A") {
      const hits = [];

      dPath.forEach((dp, i) => {
        pPath.forEach(pp => {
          if (distanceMeters(dp, pp) <= TOLERANCE_METERS) hits.push(i);
        });
      });

      const valid = [...new Set(hits)].filter(i => i >= startIdx);
      if (valid.length < 2) return;

      endIdx = Math.max(...valid);
    }

    if (currentMode === "B") {
      const passengerDest = [
        ps.destination.latitude,
        ps.destination.longitude
      ];
      endIdx = findBestExitIndex(dPath, passengerDest, startIdx);
    }

    if (endIdx !== -1) {
      overlapLine.setLatLngs(dPath.slice(startIdx, endIdx + 1));
    }
  }
}

db.ref("session").on("value", () => {
  update();
  updateRoleAvailability();
});


/* ================= ROLE ================= */
function assign(role) {
  const firstTimeChoosing = !currentRole; // pierwszy wybÃ³r

  if (firstTimeChoosing) {
    currentRole = role;

    // Zapis roli w Firebase
    db.ref("session/" + role).set({ role });
  }

  // Pobranie aktualnej lokalizacji
  navigator.geolocation.getCurrentPosition(p => {
    const lat = p.coords.latitude;
    const lng = p.coords.longitude;

    // Zapis w Firebase
    db.ref(`session/${role}/currentLocation`).set({ latitude: lat, longitude: lng });

    // ðŸ”¹ Ustawienie markera startowego od razu na mapie
    if (role === "driver") driverStartMarker.setLatLng([lat, lng]);
    if (role === "passenger") passengerStartMarker.setLatLng([lat, lng]);
  });

  // UI
  modeBtn.style.display = role === "passenger" ? "inline-block" : "none";

  if (role === "driver") driverDestinationDiv.style.display = "block";
  if (role === "passenger") passengerDestinationDiv.style.display = "block";
  if (role === "passenger") passengerStartDiv.style.display = "block";

  if (role === "passenger") {
    modeBtn.style.display = "inline-block";
    acceptBtn.style.display = "inline-block";
  }

  // OdÅ›wieÅ¼ dostÄ™pnoÅ›Ä‡ guzika
  updateRoleAvailability();
}





driverBtn.onclick = ()=>assign("driver");
passengerBtn.onclick = ()=>assign("passenger");

/* ================= BLOKADA RÃ“L ================= */

function updateRoleAvailability() {
  db.ref("session").once("value").then(snapshot => {
    const data = snapshot.val() || {};

    // DRIVER
    if ((data.driver && data.driver.role === "driver") || currentRole) {
      driverBtn.disabled = true;
      driverBtn.style.opacity = "0.4";
      driverBtn.innerText = "Driver zajÄ™ty";
    } else {
      driverBtn.disabled = false;
      driverBtn.style.opacity = "1";
      driverBtn.innerText = "Driver";
    }

    // PASSENGER
    if ((data.passenger && data.passenger.role === "passenger") || currentRole) {
      passengerBtn.disabled = true;
      passengerBtn.style.opacity = "0.4";
      passengerBtn.innerText = "Passenger zajÄ™ty";
    } else {
      passengerBtn.disabled = false;
      passengerBtn.style.opacity = "1";
      passengerBtn.innerText = "Passenger";
    }
  });
}




// start pasaÅ¼era
// saveStartBtn.addEventListener("click", () => {
 // const latSuffix = startLat.value.trim();
 // const lngSuffix = startLng.value.trim();

 // if(latSuffix.length === 3 && lngSuffix.length === 3){
  //  const lat = 52.1 + parseInt(latSuffix)/10000;
  //  const lng = 19.9 + parseInt(lngSuffix)/10000;

 //   db.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng })
 //     .then(() => console.log("Nowa lokalizacja startowa pasaÅ¼era zapisana:", lat, lng))
 //     .catch(err => console.error(err));
//  } else {
//    alert("WprowadÅº dokÅ‚adnie 3 cyfry dla szerokoÅ›ci i dÅ‚ugoÅ›ci!");
//  }
// });





// Kierowca â€“ cel
saveDriverDestinationBtn.onclick = () => {
  if (!editingDriverDestination) {
    // WÅ‚Ä…cz tryb edycji
    editingDriverDestination = true;
    saveDriverDestinationBtn.innerText = "Zapisz cel";
    return;
  }

  // Tryb zapisu
  if (selectedPoint) {
    db.ref("session/driver/destination").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingDriverDestination = false;
  saveDriverDestinationBtn.innerText = "Edytuj cel";
  selectedPoint = null;
};

// PasaÅ¼er â€“ cel
saveDestinationBtn.onclick = () => {
  if (!editingPassengerDestination) {
    editingPassengerDestination = true;
    saveDestinationBtn.innerText = "Zapisz cel";
    return;
  }

  if (selectedPoint) {
    db.ref("session/passenger/destination").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingPassengerDestination = false;
  saveDestinationBtn.innerText = "Edytuj cel";
  selectedPoint = null;
};

// PasaÅ¼er â€“ start
saveStartBtn.onclick = () => {
  if (!editingPassengerStart) {
    editingPassengerStart = true;
    saveStartBtn.innerText = "Zapisz start";
    return;
  }

  if (selectedPoint) {
    db.ref("session/passenger/currentLocation").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingPassengerStart = false;
  saveStartBtn.innerText = "Edytuj start";
  selectedPoint = null;
};


const modeBtn = document.getElementById("modeBtn");

// Zmiana trybu â€“ zapis do Firebase
modeBtn.onclick = () => {
  const newMode = currentMode === "A" ? "B" : "A";
  db.ref("session/mode").set(newMode);  // ðŸ”¹ zapis trybu globalnie
};

// Listener Firebase â€“ reaguje na zmiany trybu
db.ref("session/mode").on("value", snap => {
  const mode = snap.val();
  if (mode) {
    currentMode = mode;
    modeBtn.innerText = "Tryb " + currentMode;
    update(); // ðŸ”¹ odÅ›wieÅ¼ mapÄ™ w nowym trybie
  }
});




const acceptBtn = document.getElementById("acceptBtn");

acceptBtn.onclick = () => {
  db.ref("session/accepted").set(true);
  lockFormsAfterAccept();
};


function lockFormsAfterAccept() {
  const inputs = document.querySelectorAll(
    "#driverDestinationDiv input, #passengerDestinationDiv input, #passengerStartDiv input"
  );
  const buttons = document.querySelectorAll(
    "#driverDestinationDiv button, #passengerDestinationDiv button, #passengerStartDiv button"
  );

  inputs.forEach(i => i.disabled = true);
  buttons.forEach(b => {
    b.disabled = true;
    b.style.opacity = "0.4";
  });
}



</script>
</body>
</html>