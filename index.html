Czytelne, bez dzielonych pÃ³l, akceptacja nie dziaÅ‚a,

<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway â€“ Szachownica</title>
<style>
  body { font-family: Arial, sans-serif; }
  #roleSelect { margin: 10px 0; }
  #grid { border-collapse: collapse; margin: 20px 0; }
  #grid td { width: 40px; height: 40px; border: 1px solid #aaa; text-align: center; vertical-align: middle; cursor: pointer; position: relative; }
  .sharedCell { background-color: red !important; }
  #usersTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
  #usersTable th, #usersTable td { border: 1px solid #000; padding: 5px; text-align: center; }
  #controls { margin-top: 10px; }
  .driverCell, .passengerCell { color: #000; font-weight: bold; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

																	<h1>Crossway â€“ Szachownica 1.3</h1>

<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">PasaÅ¼er</button>
</div>

<div id="controls">
  <button id="prevDriverBtn">â¬… Cofnij</button>
  <button id="nextDriverBtn">âž¡ Dalej</button>
  <button id="acceptBtn">âœ… Akceptuj</button>
  <button id="resetBtn">ðŸ›‘ ZakoÅ„cz przejazd</button>
</div>

<table id="grid"></table>

<h2>UÅ¼ytkownicy / trasy</h2>
<table id="usersTable">
  <thead>
   <tr id="usersHeader">
  <th>ID</th>
  <th>Kolor</th>
  <th>Rola</th>
  <th>Start</th>
  <th>Cel</th>
</tr>

  </thead>
  <tbody></tbody>
</table>

<script>
  // ====== CONFIG FIREBASE ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "crossway-prototyp",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ====== STANY ======
  const ROWS = 8, COLS = 8;
  let userId = null; // zostanie ustawione po pobraniu numeru
  let userNumber = null;
  let role = null; // 'driver' lub 'passenger'
  let gridStart = null;
  let gridEnd = null;
  let usersData = {};
  let matchedDrivers = [];
  let selectedDriverIndex = 0;
  let passengersOrder = []; // [1,2,3...] â€“ kolejnoÅ›Ä‡ pasaÅ¼erÃ³w

  const driverColors = {};

  // ====== ELEMENTY ======
  const gridEl = document.getElementById('grid');
  const driverBtn = document.getElementById('driverBtn');
  const passengerBtn = document.getElementById('passengerBtn');
  const prevDriverBtn = document.getElementById('prevDriverBtn');
  const nextDriverBtn = document.getElementById('nextDriverBtn');
  const acceptBtn = document.getElementById('acceptBtn');
  const resetBtn = document.getElementById('resetBtn');
  const usersTableBody = document.querySelector('#usersTable tbody');

  // ====== INICJALIZACJA GRIDU ======
  function initGrid() {
    gridEl.innerHTML = '';
    const header = document.createElement('tr');
    header.innerHTML = '<th></th>' + Array.from({length:COLS}, (_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('');
    gridEl.appendChild(header);
    for(let r=0;r<ROWS;r++){
      let tr = document.createElement('tr');
      tr.innerHTML = `<th>${r+1}</th>`;
      for(let c=0;c<COLS;c++){
        let td = document.createElement('td');
        td.dataset.row = r;
        td.dataset.col = c;
        td.onclick = () => cellClick(r,c);
        tr.appendChild(td);
      }
      gridEl.appendChild(tr);
    }
  }

  function cellClick(r,c){
    if(!role) return;
    if(!gridStart){
      gridStart = {r,c};
      updateGrid();
    } else if(!gridEnd){
      gridEnd = {r,c};
      if(gridStart.r !== gridEnd.r && gridStart.c !== gridEnd.c){
        alert("Trasa musi byÄ‡ w linii prostej!");
        gridEnd = null;
        return;
      }
      saveRoute();
      updateGrid();
    }
  }

function updateUsersHeader(){
  const header = document.getElementById('usersHeader');
  header.innerHTML = `
    <th>ID</th>
    <th>Kolor</th>
    <th>Rola</th>
    <th>Start</th>
    <th>Cel</th>
    ${passengersOrder.map(n=>`<th>P${n}</th>`).join('')}
  `;
}

function passengerOnDriverRoute(passenger, driver){
  if(!passenger.start || !driver.start) return false;

  const ps = parseCell(passenger.start);
  const ds = parseCell(driver.start);
  const de = parseCell(driver.end);

  const cells = (ds.r===de.r)
    ? Array.from({length:Math.abs(de.c-ds.c)+1},(_,i)=>({r:ds.r,c:Math.min(ds.c,de.c)+i}))
    : Array.from({length:Math.abs(de.r-ds.r)+1},(_,i)=>({r:Math.min(ds.r,de.r)+i,c:ds.c}));

  return cells.some(c=>c.r===ps.r && c.c===ps.c);
}



function saveRoute(){
  if(!userId){
    assignUserNumber(saveRoute);
    return;
  }

  const start = `${gridStart.r},${gridStart.c}`;
  const end = `${gridEnd.r},${gridEnd.c}`;
  const color = role==='driver' ? getRandomColor() : null;

  db.ref("users/"+userId).set({
    number: userNumber,
    role,
    start,
    end,
    color,
    acceptedBy: null
  });
}


function assignUserNumber(callback){
  const ref = db.ref("meta/nextUserNumber");
  ref.transaction(current => {
    return (current || 0) + 1;
  }, (error, committed, snapshot) => {
    if(committed){
      userNumber = snapshot.val();
      userId = String(userNumber); // ID = "1", "2", "3"
      callback();
    }
  });
}


  function getRandomColor(){
    const letters = '0123456789ABCDEF';
    let color = '#';
    for(let i=0;i<6;i++) color += letters[Math.floor(Math.random()*16)];
    return color;
  }

function clearGridVisuals() {
  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      const cell = gridEl.rows[r + 1].cells[c + 1];
      cell.style.backgroundColor = '';
      cell.className = '';
    }
  }
}


function updateGrid(){
  clearGridVisuals();

    // reset
    for(let r=0;r<ROWS;r++)
      for(let c=0;c<COLS;c++)
        gridEl.rows[r+1].cells[c+1].className='';

    if(gridStart) gridEl.rows[gridStart.r+1].cells[gridStart.c+1].classList.add(role==='driver' ? 'driverCell' : 'passengerCell');
    if(gridEnd) gridEl.rows[gridEnd.r+1].cells[gridEnd.c+1].classList.add(role==='driver' ? 'driverCell' : 'passengerCell');

    // dla kierowcy rysujemy wÅ‚asnÄ… trasÄ™
    if(role==='driver' && gridStart && gridEnd){
      drawRoute(gridStart, gridEnd, driverColors[userId] || 'blue');
      // sprawdzamy czy ktoÅ› zaakceptowaÅ‚
      Object.values(usersData).forEach(u=>{
        if(u.acceptedBy===userId && u.start && u.end){
          const pStart = parseCell(u.start);
          const pEnd = parseCell(u.end);
          drawRoute(pStart,pEnd,'red'); // wspÃ³lne
          drawRoute(pStart,pEnd,'passengerCell'); // pasaÅ¼er
        }
      });
    }

    // dla pasaÅ¼era
    if(role==='passenger' && gridStart && gridEnd && matchedDrivers[selectedDriverIndex]){
      // wÅ‚asna trasa
      drawRoute(gridStart,gridEnd,'passengerCell');
      const driver = matchedDrivers[selectedDriverIndex];
      const dStart=parseCell(driver.start);
      const dEnd=parseCell(driver.end);
      drawRoute(dStart,dEnd,driver.color || 'blue');
      // wspÃ³lne pola
      const shared = getSharedCells(gridStart,gridEnd,dStart,dEnd);
      shared.forEach(cell=>{
        gridEl.rows[cell.r+1].cells[cell.c+1].classList.add('sharedCell');
      });
    }
  }

  function drawRoute(start,end,className){
    const color = className==='driverCell' ? 'blue' : className==='passengerCell' ? 'green' : className;
    if(start.r===end.r)
      for(let c=Math.min(start.c,end.c);c<=Math.max(start.c,end.c);c++)
        gridEl.rows[start.r+1].cells[c+1].style.backgroundColor=color;
    else
      for(let r=Math.min(start.r,end.r);r<=Math.max(start.r,end.r);r++)
        gridEl.rows[r+1].cells[start.c+1].style.backgroundColor=color;
  }

  function parseCell(str){
    const [r,c] = str.split(',').map(Number);
    return {r,c};
  }

  function getSharedCells(start1,end1,start2,end2){
    const cells1 = (start1.r===end1.r)
      ? Array.from({length:Math.abs(end1.c-start1.c)+1},(_,i)=>({r:start1.r,c:Math.min(start1.c,end1.c)+i}))
      : Array.from({length:Math.abs(end1.r-start1.r)+1},(_,i)=>({r:Math.min(start1.r,end1.r)+i,c:start1.c}));
    const cells2 = (start2.r===end2.r)
      ? Array.from({length:Math.abs(end2.c-start2.c)+1},(_,i)=>({r:start2.r,c:Math.min(start2.c,end2.c)+i}))
      : Array.from({length:Math.abs(end2.r-start2.r)+1},(_,i)=>({r:Math.min(start2.r,end2.r)+i,c:start2.c}));
    return cells1.filter(c1=>cells2.some(c2=>c1.r===c2.r && c1.c===c2.c));
  }

  // ====== PRZYCISKI ======
  driverBtn.onclick = ()=>{
    role='driver';
    gridStart=null; gridEnd=null;
    document.body.style.backgroundColor="#ddeeff";
    driverBtn.disabled=true; passengerBtn.disabled=true;
    initGrid();
  };
  passengerBtn.onclick = ()=>{
    role='passenger';
    gridStart=null; gridEnd=null;
    document.body.style.backgroundColor="#ddffdd";
    driverBtn.disabled=true; passengerBtn.disabled=true;
    initGrid();
  };

  nextDriverBtn.onclick = ()=>{
    if(matchedDrivers.length===0) return;
    selectedDriverIndex=(selectedDriverIndex+1)%matchedDrivers.length;
    updateGrid();
  };
  prevDriverBtn.onclick = ()=>{
    if(matchedDrivers.length===0) return;
    selectedDriverIndex=(selectedDriverIndex-1+matchedDrivers.length)%matchedDrivers.length;
    updateGrid();
  };

  acceptBtn.onclick = ()=>{
    if(role!=='passenger') return;
    const driver=matchedDrivers[selectedDriverIndex];
    db.ref("users/"+driver.id+"/acceptedBy").set(userId);
  };

  resetBtn.onclick = ()=>{
    db.ref("users").remove();
    db.ref("meta").remove(); // â¬… reset licznika
    gridStart=null; gridEnd=null;
    usersData={};
    matchedDrivers=[];
    selectedDriverIndex=0;
    driverBtn.disabled=false; passengerBtn.disabled=false;
    initGrid();
  };

  // ====== DANE FIREBASE ======
  function refreshUsers(snapshot){
passengersOrder = Object.values(usersData)
  .filter(u => u.role === 'passenger')
  .sort((a,b)=>a.number-b.number)
  .map(u => u.number);


    usersData = snapshot.val() || {};
    // kolory kierowcÃ³w
    Object.entries(usersData).forEach(([id,u])=>{
      if(u.role==='driver' && !u.color) u.color=getRandomColor();
      if(u.role==='driver') driverColors[id]=u.color;
    });

    // natychmiastowe dopasowanie pasaÅ¼era
    if(role==='passenger' && gridStart){
      matchedDrivers = Object.entries(usersData)
        .filter(([id,u])=> u.role==='driver' && u.start && u.end)
        .filter(([id,u])=>{
          const ps = gridStart;
          const dStart=parseCell(u.start);
          const dEnd=parseCell(u.end);
          const cells = (dStart.r===dEnd.r)
            ? Array.from({length:Math.abs(dEnd.c-dStart.c)+1},(_,i)=>({r:dStart.r,c:Math.min(dStart.c,dEnd.c)+i}))
            : Array.from({length:Math.abs(dEnd.r-dStart.r)+1},(_,i)=>({r:Math.min(dStart.r,dEnd.r)+i,c:dStart.c}));
          return cells.some(c=>c.r===ps.r && c.c===ps.c);
        }).map(([id,u])=>({id,...u}));
      selectedDriverIndex=0;
    }

    updateUsersTable();
    updateGrid();
  }

function updateUsersTable(){
  updateUsersHeader();
  usersTableBody.innerHTML='';

  const passengers = Object.values(usersData).filter(u=>u.role==='passenger');
  const drivers = Object.values(usersData).filter(u=>u.role==='driver');

  drivers.forEach(driver=>{
    const tr=document.createElement('tr');

    tr.innerHTML = `
      <td>${driver.number}</td>
      <td style="background:${driver.color||''}"></td>
      <td>driver</td>
      <td>${driver.start||''}</td>
      <td>${driver.end||''}</td>
      ${passengersOrder.map(pNum=>{
        const p = passengers.find(x=>x.number===pNum);
        return `<td>${p && passengerOnDriverRoute(p,driver) ? 'O' : ''}</td>`;
      }).join('')}
    `;

    usersTableBody.appendChild(tr);
  });
}


  db.ref("users").on('value',refreshUsers);

  // ====== START ======
  initGrid();
</script>
</body>
</html>
