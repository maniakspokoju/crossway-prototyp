<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Crossway Multi-user</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
    font-family: sans-serif;
    margin: 0;
    transition: background-color 0.3s ease;
    height: 100vh;
    display: flex;
    flex-direction: column;
}

/* ROLE BAR */
#roleBar {
  display: flex;
  width: 100%;
}
#roleBar button {
  width: 50%;
  height: 80px;
  font-size: 28px;
  border-radius: 0;
  cursor: pointer;
}
#driverBtn { background-color: #2f6fff; color: white; }
#passengerBtn { background-color: #2fbf6f; color: white; }

/* PANEL UŻYTKOWNIKA */
#driverDestinationDiv, #passengerControls {
  display: none;
  padding: 10px;
}
#driverDestinationDiv button, #passengerControls button {
  font-size: 24px;
  padding: 12px;
  margin: 5px 0;
  border-radius: 12px;
  cursor: pointer;
}
#driverDestinationDiv button:active, #passengerControls button:active {
  transform: scale(0.97);
}

/* MAPA */
#map {
  flex: 1;
}
</style>
</head>

<body>

									<h1 style="margin:5px 10px;">Crossway – 5.8.5</h1>

<div id="roleBar">
  <button id="driverBtn">Driver</button>
  <button id="passengerBtn">Passenger</button>
</div>

<div id="driverDestinationDiv">
  <button id="saveDriverDestinationBtn">Edytuj cel</button>
</div>

<div id="passengerControls">
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <button id="modeBtn" style="flex:5;">Tryb A</button>
    <button id="acceptBtn" style="flex:8; background:#ff5722; color:white;">Akceptuj trasę</button>
  </div>
  <div style="display:flex; gap:10px;">
    <button id="saveDestinationBtn" style="flex:1;">Edytuj cel</button>
    <button id="saveStartBtn" style="flex:1;">Edytuj start</button>
  </div>
</div>

<div id="driverBrowseControls" style="display:none; gap:10px; margin-top:10px;">
  <button id="prevDriverBtn" style="flex:1;">Cofnij</button>
  <button id="nextDriverBtn" style="flex:1;">Dalej</button>
</div>


<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();

/* ================= GLOBAL ================= */
let currentUserId = null;
let currentRole = null;
let usersMarkers = {};
let selectedPoint = null;
let editingDestination = false;
let editingStart = false;
let currentMode = "A";
let acceptLocked = false;
// let matchingDrivers = [];
// let currentDriverIndex = 0;


// ===== Funkcja pobierająca kolejny numer użytkownika =====
async function getNextUserId() {
  const userCountRef = db.ref("session/userCount");
  const snapshot = await userCountRef.transaction(current => {
    return (current || 0) + 1; // jeśli brak, ustaw 1, inaczej zwiększ
  });
  return snapshot.snapshot.val(); // to będzie numer kolejnego użytkownika
}

/* ================= MAPA ================= */
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const overlapLine = L.polyline([], { color: "red", weight: 7 }).addTo(map);

/* ================= UTILS ================= */
const TOLERANCE_METERS = 160;
function distanceMeters(a,b){
  const R=6371000,dLat=(b[0]-a[0])*Math.PI/180,dLng=(b[1]-a[1])*Math.PI/180,x=dLng*Math.cos((a[0]+b[0])/2*Math.PI/180);
  return Math.sqrt(dLat*dLat+x*x)*R;
}
function findClosestIndex(point,path){
  let min=Infinity, idx=-1;
  path.forEach((p,i)=>{
    const d = distanceMeters(point,[p.lat,p.lng]);
    if(d<min){min=d;idx=i;}
  });
  return min<=TOLERANCE_METERS?idx:-1;
}
function createIcon(userId, color){
  return L.divIcon({
    html:`<div style="font-size:26px;font-weight:bold;color:${color}">${userId}</div>`,
    className:"",
    iconSize:[30,30],
    iconAnchor:[15,15]
  });
}

async function route(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

function randomColor(){
  return "#" + Math.floor(Math.random()*16777215).toString(16).padStart(6,"0");
}

/* ================= CREATE USER ================= */
async function createUser(role){
  currentUserId = await getNextUserId(); // nowy numer: 1,2,3...
  currentRole = role;

  const userColor = role === "driver" ? randomColor() : "green";

const startMarker = L.marker([0,0], {
  icon: createIcon(currentUserId, userColor)
}).addTo(map);

const endMarker = L.marker([0,0], {
  icon: createIcon(currentUserId, userColor)
}).addTo(map);

const line = L.polyline([], {
  color: userColor,
  weight: 5
}).addTo(map);

  usersMarkers[currentUserId] = {
  startMarker,
  endMarker,
  line,
  role,
  color: userColor,
  matchingDrivers: [],
  currentDriverIndex: 0
};



  navigator.geolocation.getCurrentPosition(p=>{
    const lat=p.coords.latitude, lng=p.coords.longitude;
    startMarker.setLatLng([lat,lng]);
    db.ref(`session/users/${currentUserId}`).set({
  role,
  color: userColor,
  currentLocation:{ latitude:lat, longitude:lng }
});
  });

  if(role==="driver") document.getElementById("driverDestinationDiv").style.display="block";
  if(role==="passenger") document.getElementById("passengerControls").style.display="block";

  // blokada przycisków ról po wyborze
  document.getElementById("driverBtn").disabled=true;
  document.getElementById("driverBtn").style.opacity="0.4";
  document.getElementById("passengerBtn").disabled=true;
  document.getElementById("passengerBtn").style.opacity="0.4";
}

/* ================= MAP CLICK ================= */
map.on("click", function(e){
  if(!editingDestination && !editingStart) return;
  selectedPoint=[e.latlng.lat,e.latlng.lng];
  if(editingDestination) usersMarkers[currentUserId].endMarker.setLatLng(selectedPoint);
  if(editingStart) usersMarkers[currentUserId].startMarker.setLatLng(selectedPoint);
  drawUserRoute(currentUserId);
});

/* ================= DRAW ROUTE ================= */
async function drawUserRoute(userId){
  const user = usersMarkers[userId];
  if(!user) return;
  const start = user.startMarker.getLatLng();
  const end = user.endMarker.getLatLng();
  const coords = await route([start.lat,start.lng],[end.lat,end.lng]);
  user.line.setLatLngs(coords);
}

/* ================= SAVE BUTTONS ================= */
const saveDriverDestinationBtn = document.getElementById("saveDriverDestinationBtn");
saveDriverDestinationBtn.onclick = async ()=>{
  if(!editingDestination){editingDestination=true; saveDriverDestinationBtn.innerText="Zapisz cel"; return;}
  if(selectedPoint){
    usersMarkers[currentUserId].endMarker.setLatLng(selectedPoint);
    db.ref(`session/users/${currentUserId}/destination`).set({latitude:selectedPoint[0],longitude:selectedPoint[1]});
    drawUserRoute(currentUserId);
  }
  editingDestination=false;
  saveDriverDestinationBtn.innerText="Edytuj cel";
  selectedPoint=null;
};

const saveDestinationBtn = document.getElementById("saveDestinationBtn");
saveDestinationBtn.onclick = async ()=>{
  if(!editingDestination){editingDestination=true; saveDestinationBtn.innerText="Zapisz cel"; return;}
  if(selectedPoint){
    usersMarkers[currentUserId].endMarker.setLatLng(selectedPoint);
    db.ref(`session/users/${currentUserId}/destination`).set({latitude:selectedPoint[0],longitude:selectedPoint[1]});
    await drawUserRoute(currentUserId);

if (currentRole === "passenger") {
  findMatchingDrivers(currentUserId);
console.log(matchingDrivers);
  showCurrentDriver();
}
  }
  editingDestination=false;
  saveDestinationBtn.innerText="Edytuj cel";
  selectedPoint=null;
};

const saveStartBtn = document.getElementById("saveStartBtn");
saveStartBtn.onclick = async ()=>{
  if(!editingStart){editingStart=true; saveStartBtn.innerText="Zapisz start"; return;}

  if(selectedPoint){
    usersMarkers[currentUserId].startMarker.setLatLng(selectedPoint);
    db.ref(`session/users/${currentUserId}/currentLocation`).set({
      latitude:selectedPoint[0],
      longitude:selectedPoint[1]
    });

    await drawUserRoute(currentUserId);

    if (currentRole === "passenger") {
      findMatchingDrivers(currentUserId);
console.log(matchingDrivers);
      showCurrentDriver();
    }
  }

  editingStart=false;
  saveStartBtn.innerText="Edytuj start";
  selectedPoint=null;
};


/* ================= MODE ================= */
const modeBtn = document.getElementById("modeBtn");
modeBtn.onclick = ()=>{
  const newMode = currentMode==="A"?"B":"A";
  db.ref("session/mode").set(newMode);
};
db.ref("session/mode").on("value", snap=>{
  if(snap.val()) currentMode=snap.val();
  modeBtn.innerText="Tryb "+currentMode;
  if(currentRole==="passenger") checkOverlaps();
});

/* ================= OVERLAP ================= */
function findMatchingDrivers(passengerId){
  matchingDrivers = [];
  currentDriverIndex = 0;

  const passenger = usersMarkers[passengerId];
  if (!passenger) return;

  const pStart = passenger.startMarker.getLatLng();

  for (let uid in usersMarkers) {
    const user = usersMarkers[uid];
    if (user.role !== "driver") continue;

    const path = user.line.getLatLngs();
    if (!path || path.length === 0) continue;

    const idx = findClosestIndex([pStart.lat, pStart.lng], path);
    if (idx !== -1) {
      matchingDrivers.push({
        driverId: uid,
        fromIndex: idx
      });
    }
  }

  // POKAZUJEMY GUZIKI NA PRZEGLĄDANIE
  if (matchingDrivers.length > 0) {
    document.getElementById("driverBrowseControls").style.display = "flex";
  } else {
    document.getElementById("driverBrowseControls").style.display = "none";
  }
}


function showCurrentDriver(){
  overlapLine.setLatLngs([]);

  if (matchingDrivers.length === 0) return;

  const match = matchingDrivers[currentDriverIndex];
  const driver = usersMarkers[match.driverId];

  if (!driver) return;

  const path = driver.line.getLatLngs();
  overlapLine.setLatLngs(path.slice(match.fromIndex));
}


document.getElementById("nextDriverBtn").onclick = () => {
  const p = usersMarkers[currentUserId];
  if (!p || p.currentDriverIndex >= p.matchingDrivers.length - 1) return;
  p.currentDriverIndex++;
  showCurrentDriver();
};

document.getElementById("prevDriverBtn").onclick = () => {
  const p = usersMarkers[currentUserId];
  if (!p || p.currentDriverIndex <= 0) return;
  p.currentDriverIndex--;
  showCurrentDriver();
};



/* ================= EVENTY ROLE ================= */
document.getElementById("driverBtn").onclick = ()=>{document.body.style.backgroundColor="#2f6fff"; createUser("driver");};
document.getElementById("passengerBtn").onclick = ()=>{document.body.style.backgroundColor="#2fbf6f"; createUser("passenger");};

/* ================= SYNC USERS ================= */
/*
db.ref("session/users").on("value", snap=>{
  const allUsers = snap.val()||{};
  for(let uid in allUsers){
    if(usersMarkers[uid]) continue;
    const data = allUsers[uid];
    const role=data.role;
    const startMarker = L.marker([data.currentLocation.latitude,data.currentLocation.longitude],{icon:createIcon(role)}).addTo(map);
    const endLat = data.destination?.latitude||data.currentLocation.latitude;
    const endLng = data.destination?.longitude||data.currentLocation.longitude;
    const endMarker = L.marker([endLat,endLng],{icon:createIcon(role)}).addTo(map);
    const line = L.polyline([], { color: role==="driver"?"blue":"green", weight:5 }).addTo(map);
    usersMarkers[uid]={startMarker,endMarker,line,role};
    if(data.destination) drawUserRoute(uid);
  }
});
*/

</script>

</body>
</html>
