<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Crossway 1.9</title>
</head>
<body>
    <h1>Crossway 1.9</h1>
    <p>Wybierz swoją rolę i sprawdź geolokalizację</p>

    <button id="driverBtn">Driver</button>
    <button id="passengerBtn">Passenger</button>
    <p id="role"></p>

    <!-- Pasażer wybiera cel -->
    <div id="passengerDestinationDiv" style="display:none;">
        <h3>Wskaż lokalizację docelową:</h3>
        <input type="number" id="destLat" placeholder="Szerokość" step="0.000001">
        <input type="number" id="destLng" placeholder="Długość" step="0.000001">
        <button id="saveDestinationBtn">Zapisz cel</button>
    </div>

<!-- Firebase App (Core SDK) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  authDomain: "crossway-prototyp.firebaseapp.com",
  projectId: "crossway-prototyp",
  storageBucket: "crossway-prototyp.firebasestorage.app",
  messagingSenderId: "852476458596",
  appId: "1:852476458596:web:f901da16de7dc8a3551171",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// Reset sesji dla testów
database.ref("session").remove()
  .then(() => console.log("Sesja zresetowana"))
  .catch(err => console.error("Błąd resetu sesji:", err));

// Funkcja przydziału roli
function assignRole(role) {
  document.getElementById("role").innerText = "Twoja rola: " + role;

  // Zapis roli w Firebase
  database.ref(`session/${role}`).set({role: role})
    .then(() => console.log("Rola zapisana:", role))
    .catch(err => console.error("Błąd zapisu roli:", err));

  // Jeśli driver, zapis lokalizacji aktualnej + docelowej
  if (role === "driver" && "geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // Aktualna lokalizacja kierowcy
      database.ref("session/driver/currentLocation").set({ latitude: lat, longitude: lng })
        .then(() => console.log("Aktualna lokalizacja driver zapisana!"))
        .catch(err => console.error(err));

      // Docelowa lokalizacja kierowcy (ok. 2km od obecnej)
      const destinationLat = lat + 0.018; // ~2km w przybliżeniu
      const destinationLng = lng + 0.018;
      database.ref("session/driver/destination").set({ latitude: destinationLat, longitude: destinationLng })
        .then(() => console.log("Docelowa lokalizacja driver zapisana!"))
        .catch(err => console.error(err));

    }, error => console.error("Błąd pobrania lokalizacji:", error.message));
  }

  // Jeśli passenger, pokaż panel wyboru celu
  if (role === "passenger") {
    document.getElementById("passengerDestinationDiv").style.display = "block";
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        database.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng })
          .then(() => console.log("Aktualna lokalizacja passenger zapisana!"))
          .catch(err => console.error(err));
      }, error => console.error("Błąd pobrania lokalizacji:", error.message));
    }
  }
}

// Zapis lokalizacji docelowej pasażera
document.getElementById("saveDestinationBtn").addEventListener("click", () => {
  const lat = parseFloat(document.getElementById("destLat").value);
  const lng = parseFloat(document.getElementById("destLng").value);
  if (!isNaN(lat) && !isNaN(lng)) {
    database.ref("session/passenger/destination").set({ latitude: lat, longitude: lng })
      .then(() => console.log("Docelowa lokalizacja passenger zapisana!"))
      .catch(err => console.error(err));
  } else {
    alert("Wprowadź poprawne współrzędne!");
  }
});

// Obsługa przycisków
document.getElementById("driverBtn").addEventListener("click", () => assignRole("driver"));
document.getElementById("passengerBtn").addEventListener("click", () => assignRole("passenger"));
</script>
</body>
</html>
