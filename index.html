<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway â€“ Szachownica</title>
<style>
  body { font-family: Arial, sans-serif; }
  #roleSelect { margin: 10px 0; }
  #grid { border-collapse: collapse; margin: 20px 0; }
  #grid td { width: 40px; height: 40px; border: 1px solid #aaa; text-align: center; vertical-align: middle; cursor: pointer; position: relative; }
  .sharedCell { background-color: red !important; }
  #usersTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
  #usersTable th, #usersTable td { border: 1px solid #000; padding: 5px; text-align: center; }
  #controls { margin-top: 10px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

<h1>Crossway â€“ Szachownica</h1>

<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">PasaÅ¼er</button>
</div>

<div id="controls">
  <button id="prevDriverBtn">â¬… Cofnij</button>
  <button id="nextDriverBtn">âž¡ Dalej</button>
  <button id="acceptBtn">âœ… Akceptuj</button>
  <button id="resetBtn">ðŸ›‘ ZakoÅ„cz przejazd</button>
</div>

<table id="grid"></table>

<h2>UÅ¼ytkownicy / trasy</h2>
<table id="usersTable">
  <thead>
    <tr id="usersHeader">
      <th>ID</th>
      <th>Kolor</th>
      <th>Rola</th>
      <th>Start</th>
      <th>Cel</th>
    </tr>
  </thead>
  <tbody id="usersBody"></tbody>
</table>

<script>
  // ====== CONFIG FIREBASE ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "crossway-prototyp",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const ROWS=8, COLS=8;
  let userId = crypto.randomUUID();
  let role = null;
  let gridStart = null;
  let gridEnd = null;
  let usersData = {};
  let matchedDrivers = [];
  let selectedDriverIndex = 0;
  const driverColors = {};
  const passengersCols = {}; // ID pasaÅ¼era -> numer kolumny

  const gridEl = document.getElementById('grid');
  const driverBtn = document.getElementById('driverBtn');
  const passengerBtn = document.getElementById('passengerBtn');
  const prevDriverBtn = document.getElementById('prevDriverBtn');
  const nextDriverBtn = document.getElementById('nextDriverBtn');
  const acceptBtn = document.getElementById('acceptBtn');
  const resetBtn = document.getElementById('resetBtn');
  const usersHeader = document.getElementById('usersHeader');
  const usersBody = document.getElementById('usersBody');

  function initGrid() {
    gridEl.innerHTML='';
    const header = document.createElement('tr');
    header.innerHTML='<th></th>'+Array.from({length:COLS},(_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('');
    gridEl.appendChild(header);
    for(let r=0;r<ROWS;r++){
      let tr = document.createElement('tr');
      tr.innerHTML=`<th>${r+1}</th>`;
      for(let c=0;c<COLS;c++){
        let td=document.createElement('td');
        td.dataset.row=r;
        td.dataset.col=c;
        td.onclick=()=>cellClick(r,c);
        tr.appendChild(td);
      }
      gridEl.appendChild(tr);
    }
  }

  function cellClick(r,c){
    if(!role) return;
    if(!gridStart){ gridStart={r,c}; updateGrid(); }
    else if(!gridEnd){ 
      gridEnd={r,c};
      if(gridStart.r!==gridEnd.r && gridStart.c!==gridEnd.c){
        alert("Trasa musi byÄ‡ w linii prostej!");
        gridEnd=null;
        return;
      }
      saveRoute();
      updateGrid();
    }
  }

  function saveRoute(){
    const start=`${gridStart.r},${gridStart.c}`;
    const end=`${gridEnd.r},${gridEnd.c}`;
    const color = role==='driver' ? getRandomColor() : null;
    db.ref("users/"+userId).set({role,start,end,color,acceptedBy:null});
  }

  function getRandomColor(){
    const letters='0123456789ABCDEF'; let color='#';
    for(let i=0;i<6;i++) color+=letters[Math.floor(Math.random()*16)];
    return color;
  }

  function updateGrid(){
    for(let r=0;r<ROWS;r++)
      for(let c=0;c<COLS;c++)
        gridEl.rows[r+1].cells[c+1].style.backgroundColor='';

    if(gridStart) drawRoute(gridStart,gridEnd || gridStart,'passengerCell');

    // kierowca rysuje wÅ‚asnÄ… trasÄ™
    if(role==='driver' && gridStart && gridEnd){
      drawRoute(gridStart,gridEnd,driverColors[userId]||'blue');
      Object.entries(usersData).forEach(([id,u])=>{
        if(u.acceptedBy===userId && u.start && u.end){
          const pStart=parseCell(u.start); const pEnd=parseCell(u.end);
          drawRoute(pStart,pEnd,'passengerCell');
          const shared = getSharedCells(gridStart,gridEnd,pStart,pEnd);
          shared.forEach(c=>gridEl.rows[c.r+1].cells[c.c+1].style.backgroundColor='red');
        }
      });
    }

    // pasaÅ¼er
    if(role==='passenger' && gridStart && gridEnd){
      drawRoute(gridStart,gridEnd,'passengerCell'); // zawsze wÅ‚asna
      if(matchedDrivers[selectedDriverIndex]){
        const d=matchedDrivers[selectedDriverIndex];
        const dStart=parseCell(d.start), dEnd=parseCell(d.end);
        drawRoute(dStart,dEnd,d.color||'blue');
        const shared=getSharedCells(gridStart,gridEnd,dStart,dEnd);
        shared.forEach(c=>gridEl.rows[c.r+1].cells[c.c+1].style.backgroundColor='red');
      }
    }
  }

  function drawRoute(start,end,className){
    const color=className==='driverCell'? 'blue' : className==='passengerCell'? 'green' : className;
    if(start.r===end.r)
      for(let c=Math.min(start.c,end.c);c<=Math.max(start.c,end.c);c++)
        gridEl.rows[start.r+1].cells[c+1].style.backgroundColor=color;
    else
      for(let r=Math.min(start.r,end.r);r<=Math.max(start.r,end.r);r++)
        gridEl.rows[r+1].cells[start.c+1].style.backgroundColor=color;
  }

  function parseCell(str){const [r,c]=str.split(',').map(Number);return {r,c};}
  function getSharedCells(s1,e1,s2,e2){
    const cells1=(s1.r===e1.r)?Array.from({length:Math.abs(e1.c-s1.c)+1},(_,i)=>({r:s1.r,c:Math.min(s1.c,e1.c)+i})):Array.from({length:Math.abs(e1.r-s1.r)+1},(_,i)=>({r:Math.min(s1.r,e1.r)+i,c:s1.c}));
    const cells2=(s2.r===e2.r)?Array.from({length:Math.abs(e2.c-s2.c)+1},(_,i)=>({r:s2.r,c:Math.min(s2.c,e2.c)+i})):Array.from({length:Math.abs(e2.r-s2.r)+1},(_,i)=>({r:Math.min(s2.r,e2.r)+i,c:s2.c}));
    return cells1.filter(c1=>cells2.some(c2=>c1.r===c2.r && c1.c===c2.c));
  }

  driverBtn.onclick=()=>{
    role='driver'; gridStart=null; gridEnd=null;
    document.body.style.backgroundColor="#ddeeff";
    driverBtn.disabled=true; passengerBtn.disabled=true;
    initGrid();
  };
  passengerBtn.onclick=()=>{
    role='passenger'; gridStart=null; gridEnd=null;
    document.body.style.backgroundColor="#ddffdd";
    driverBtn.disabled=true; passengerBtn.disabled=true;
    initGrid();
  };

  nextDriverBtn.onclick=()=>{
    if(matchedDrivers.length===0) return;
    selectedDriverIndex=(selectedDriverIndex+1)%matchedDrivers.length;
    updateGrid();
  };
  prevDriverBtn.onclick=()=>{
    if(matchedDrivers.length===0) return;
    selectedDriverIndex=(selectedDriverIndex-1+matchedDrivers.length)%matchedDrivers.length;
    updateGrid();
  };

  acceptBtn.onclick=()=>{
    if(role!=='passenger') return;
    const driver=matchedDrivers[selectedDriverIndex];
    db.ref("users/"+driver.id+"/acceptedBy").set(userId);
    driverBtn.disabled=true; passengerBtn.disabled=true;
    acceptBtn.disabled=true; nextDriverBtn.disabled=true; prevDriverBtn.disabled=true;
  };

  resetBtn.onclick=()=>{
    db.ref("users").remove();
    gridStart=null; gridEnd=null;
    usersData={}; matchedDrivers=[]; selectedDriverIndex=0;
    driverBtn.disabled=false; passengerBtn.disabled=false;
    initGrid();
  };

  function refreshUsers(snapshot){
    usersData=snapshot.val()||{};
    Object.entries(usersData).forEach(([id,u])=>{
      if(u.role==='driver' && !u.color) u.color=getRandomColor();
      if(u.role==='driver') driverColors[id]=u.color;
    });

    if(role==='passenger' && gridStart){
      matchedDrivers = Object.entries(usersData)
        .filter(([id,u])=> u.role==='driver' && u.start && u.end)
        .filter(([id,u])=>{
          const ps=gridStart;
          const dStart=parseCell(u.start); const dEnd=parseCell(u.end);
          const cells=(dStart.r===dEnd.r)?Array.from({length:Math.abs(dEnd.c-dStart.c)+1},(_,i)=>({r:dStart.r,c:Math.min(dStart.c,dEnd.c)+i})):Array.from({length:Math.abs(dEnd.r-dStart.r)+1},(_,i)=>({r:Math.min(dStart.r,dEnd.r)+i,c:dStart.c}));
          return cells.some(c=>c.r===ps.r && c.c===ps.c);
        }).map(([id,u])=>({id,...u}));
      selectedDriverIndex=0;
    }

    updateUsersTable(); updateGrid();
  }

  function updateUsersTable(){
    usersHeader.innerHTML='<th>ID</th><th>Kolor</th><th>Rola</th><th>Start</th><th>Cel</th>';
    // dodaj kolumny pasaÅ¼erÃ³w
    const passengerIds = Object.entries(usersData).filter(([id,u])=>u.role==='passenger').map(([id,u])=>id);
    passengerIds.forEach(pid=>{
      if(!passengersCols[pid]){
        passengersCols[pid]=usersHeader.children.length;
        const th=document.createElement('th'); th.textContent=pid; usersHeader.appendChild(th);
      }
    });

    usersBody.innerHTML='';
    Object.entries(usersData).forEach(([id,u])=>{
      const tr=document.createElement('tr');
      const colorCell=u.color? `<td style="background-color:${u.color}"></td>` : '<td></td>';
      tr.innerHTML=`<td>${id}</td>${colorCell}<td>${u.role||''}</td><td>${u.start||''}</td><td>${u.end||''}</td>`;
      passengerIds.forEach(pid=>{
        let val=''; if(u.role==='driver' && usersData[pid] && usersData[pid].acceptedBy===id) val='âœ…';
        tr.innerHTML+=`<td>${val}</td>`;
      });
      usersBody.appendChild(tr);
    });
  }

  db.ref("users").on('value',refreshUsers);

  initGrid();
</script>
</body>
</html>
