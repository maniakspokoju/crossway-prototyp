<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway â€“ Szachownica</title>
<style>
  body { font-family: Arial, sans-serif; }
  #roleSelect { margin: 10px 0; }
  .sharedCell { background-color: red !important; }
  #usersTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
  #usersTable th, #usersTable td { border: 1px solid #000; padding: 5px; text-align: center; }
  #controls { margin-top: 10px; }
  .driverCell, .passengerCell { color: #000; font-weight: bold; }
#mainView {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

#map {
  width: 360px;
  height: 360px;
  border: 1px solid #aaa;
}

</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
</head>
<body>

															<h1>Crossway â€“ Szachownica 5.4.2</h1>

<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">PasaÅ¼er</button>
</div>

<div id="controls">
  <button id="prevDriverBtn">â¬… Cofnij</button>
  <button id="nextDriverBtn">âž¡ Dalej</button>
  <button id="acceptBtn">âœ… Akceptuj</button>
  <button id="resetBtn">ðŸ›‘ ZakoÅ„cz przejazd</button>
  <button id="goalBtn">ðŸŽ¯ Edytuj cel</button>
</div>


<div id="assignedPassenger" style="margin-top:10px; font-weight:bold;"></div>






<h2>UÅ¼ytkownicy / trasy</h2>
<table id="usersTable">
  <thead>
   <tr id="usersHeader">
  <th>ID</th>
  <th>Kolor</th>
</tr>

  </thead>
  <tbody></tbody>
</table>

<script>
  // ====== CONFIG FIREBASE ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "crossway-prototyp",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ====== STANY ======
  let userId = null;
  let userNumber = null;
  let role = null; // 'driver' lub 'passenger'
  let usersData = {};
  let myColor = null;
  let userLocation = null;
  let myMarker = null;
  let goalEditMode = false;
  let goalMarker = null;
  let routeControl = null;

  const driverColors = {};
  const passengersOrder = [];

  // ====== ELEMENTY ======
  const driverBtn = document.getElementById('driverBtn');
  const passengerBtn = document.getElementById('passengerBtn');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const goalBtn = document.getElementById('goalBtn');

  // ====== FUNKCJE ======
  function getRandomColor(){
    const letters = '0123456789ABCDEF';
    let color = '#';
    for(let i=0;i<6;i++) color += letters[Math.floor(Math.random()*16)];
    return color;
  }

  function assignUserNumber(callback){
    const ref = db.ref("meta/nextUserNumber");
    ref.transaction(current => (current || 0) + 1, (error, committed, snapshot) => {
      if(committed){
        userNumber = snapshot.val();
        userId = String(userNumber);
        callback();
      }
    });
  }

  function tryCreateMyMarker() {
    if (!map || !userId || !userNumber || !myColor || !userLocation) return;
    if (myMarker) return; // nie tworzymy drugi raz

    const icon = L.divIcon({
      className: '',
      html: `<div style="
        background:${myColor};
        color:#fff;
        width:26px;
        height:26px;
        border-radius:50%;
        text-align:center;
        line-height:26px;
        font-weight:bold;
        border:2px solid #000;
      ">${userNumber}</div>`,
      iconSize: [26,26],
      iconAnchor: [13,13]
    });

    myMarker = L.marker([userLocation.lat, userLocation.lng], { icon }).addTo(map);
    map.setView([userLocation.lat, userLocation.lng], 14);
  }

  function getUserLocation() {
    if (!navigator.geolocation) { alert("Brak obsÅ‚ugi GPS"); return; }

    navigator.geolocation.getCurrentPosition(pos => {
      userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      tryCreateMyMarker();
    }, err => { alert("Nie udaÅ‚o siÄ™ pobraÄ‡ lokalizacji"); });
  }

  function updateUsersHeader(){
    const thead = document.querySelector('#usersTable thead');
    thead.innerHTML = `<tr><th>#</th><th>Kolor</th></tr>`;
  }

  function updateUsersTable(){
    updateUsersHeader();
    usersTableBody.innerHTML = '';

    Object.values(usersData).forEach(u => {
      const tr = document.createElement('tr');
      const color = u.color || '';
      tr.innerHTML = `<td>${u.number}</td><td style="background:${color}"></td>`;
      usersTableBody.appendChild(tr);
    });
  }

  function drawRouteOnMap(startLatLng, endLatLng, color, role){
    if(routeControl) map.removeControl(routeControl);

    routeControl = L.Routing.control({
      waypoints: [L.latLng(startLatLng.lat, startLatLng.lng), L.latLng(endLatLng.lat, endLatLng.lng)],
      lineOptions: { styles:[{ color: color, weight: 5 }] },
      router: L.Routing.osrmv1({
        serviceUrl:'https://router.project-osrm.org/route/v1',
        profile: role==='driver'?'car':'foot'
      }),
      show:false,
      addWaypoints:false,
      routeWhileDragging:false,
      fitSelectedRoutes:true
    }).addTo(map);
  }

  // ====== PRZYCISKI ======
  driverBtn.onclick = () => {
    role = 'driver';
    document.body.style.backgroundColor = "#ddeeff";
    driverBtn.disabled = passengerBtn.disabled = true;

    assignUserNumber(() => {
      myColor = getRandomColor();
      updateUsersTable();
    });

    getUserLocation();
  };

  passengerBtn.onclick = () => {
    role = 'passenger';
    document.body.style.backgroundColor = "#ddffdd";
    driverBtn.disabled = passengerBtn.disabled = true;

    assignUserNumber(() => {
      myColor = 'green';
      updateUsersTable();
    });

    getUserLocation();
  };

  goalBtn.onclick = () => {
    goalEditMode = !goalEditMode;
    goalBtn.textContent = goalEditMode ? 'ðŸ’¾ Zapisz cel' : 'ðŸŽ¯ Edytuj cel';
  };

  // ====== MAPA ======
  const map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'Â© OpenStreetMap' }).addTo(map);
  map.setView([52.23,21.01],13);

  map.on('click', e => {
    if(!goalEditMode || !userLocation) return;

    const endLatLng = { lat:e.latlng.lat, lng:e.latlng.lng };
    drawRouteOnMap(userLocation, endLatLng, myColor, role);

    if(!goalMarker) goalMarker = L.marker([endLatLng.lat, endLatLng.lng]).addTo(map);
    else goalMarker.setLatLng([endLatLng.lat, endLatLng.lng]);
  });

  // ====== FIREBASE ======
  db.ref("users").on('value', snapshot => {
    usersData = snapshot.val() || {};

    // kolory kierowcÃ³w
    Object.entries(usersData).forEach(([id,u]) => {
      if(u.role==='driver' && !u.color) u.color=getRandomColor();
      if(u.role==='driver') driverColors[id]=u.color;
    });

    updateUsersTable();
  });
</script>
</body>
</html>
