<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway â€“ Szachownica</title>
<style>
  body { font-family: Arial, sans-serif; }
  #roleSelect { margin: 10px 0; }
  #grid { border-collapse: collapse; margin: 20px 0; }
  #grid td { width: 40px; height: 40px; border: 1px solid #aaa; text-align: center; vertical-align: middle; cursor: pointer; position: relative; }
  .sharedCell { background-color: red !important; }
  #usersTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
  #usersTable th, #usersTable td { border: 1px solid #000; padding: 5px; text-align: center; }
  #controls { margin-top: 10px; }
  .driverCell, .passengerCell { color: #000; font-weight: bold; }
#mainView {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

#map {
  width: 360px;
  height: 360px;
  border: 1px solid #aaa;
}

</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
</head>
<body>

															<h1>Crossway â€“ Szachownica 5.6.7</h1>

<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">PasaÅ¼er</button>
</div>

<div id="controls">
  <button id="prevDriverBtn">â¬… Cofnij</button>
  <button id="nextDriverBtn">âž¡ Dalej</button>
  <button id="acceptBtn">âœ… Akceptuj</button>
  <button id="resetBtn">ðŸ›‘ ZakoÅ„cz przejazd</button>
  <button id="goalBtn">ðŸŽ¯ Edytuj cel</button>

</div>


<div id="assignedPassenger" style="margin-top:10px; font-weight:bold;"></div>



<div id="mainView">
  <table id="grid"></table>
  <div id="map"></div>
</div>


<h2>UÅ¼ytkownicy / trasy</h2>
<table id="usersTable">
  <thead>
   <tr id="usersHeader">
  <th>ID</th>
  <th>Kolor</th>
</tr>

  </thead>
  <tbody></tbody>
</table>

<script>
  // ====== CONFIG FIREBASE ======
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "crossway-prototyp",
    storageBucket: "YOUR_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ====== STANY ======
  const ROWS = 8, COLS = 8;
  let userId = null;
  let userNumber = null;
  let role = null; 
  let gridStart = null;
  let gridEnd = null;
  let usersData = {};
  let matchedDrivers = [];
  let selectedDriverIndex = 0;
  let passengersOrder = [];
  let acceptedDriverId = null;
  let myColor = null;
  let userLocation = null;
  let myMarker = null;
  let goalEditMode = false;
  let goalMarker = null;
  let routeControl = null;
  const driverColors = {};

  // ====== ELEMENTY ======
  const gridEl = document.getElementById('grid');
  const driverBtn = document.getElementById('driverBtn');
  const passengerBtn = document.getElementById('passengerBtn');
  const prevDriverBtn = document.getElementById('prevDriverBtn');
  const nextDriverBtn = document.getElementById('nextDriverBtn');
  const acceptBtn = document.getElementById('acceptBtn');
  const resetBtn = document.getElementById('resetBtn');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const goalBtn = document.getElementById('goalBtn');

  // ====== INICJALIZACJA GRIDU ======
  function initGrid() {
    gridEl.innerHTML = '';
    const header = document.createElement('tr');
    header.innerHTML = '<th></th>' + Array.from({length:COLS}, (_,i)=>`<th>${String.fromCharCode(65+i)}</th>`).join('');
    gridEl.appendChild(header);
    for(let r=0;r<ROWS;r++){
      let tr = document.createElement('tr');
      tr.innerHTML = `<th>${r+1}</th>`;
      for(let c=0;c<COLS;c++){
        let td = document.createElement('td');
        td.dataset.row = r;
        td.dataset.col = c;
        td.onclick = () => cellClick(r,c);
        tr.appendChild(td);
      }
      gridEl.appendChild(tr);
    }
  }

  function cellClick(r,c){
    if(!role) return;
    if(!gridStart){
      gridStart = {r,c};
      updateGrid();
    } else if(!gridEnd){
      gridEnd = {r,c};
      if(gridStart.r !== gridEnd.r && gridStart.c !== gridEnd.c){
        alert("Trasa musi byÄ‡ w linii prostej!");
        gridEnd = null;
        return;
      }
      saveRoute();
      updateGrid();
    }
  }

  function parseCell(str){ const [r,c]=str.split(',').map(Number); return {r,c}; }

  function getSharedCells(start1,end1,start2,end2){
    const cells1=(start1.r===end1.r)?Array.from({length:Math.abs(end1.c-start1.c)+1},(_,i)=>({r:start1.r,c:Math.min(start1.c,end1.c)+i})):
                 Array.from({length:Math.abs(end1.r-start1.r)+1},(_,i)=>({r:Math.min(start1.r,end1.r)+i,c:start1.c}));
    const cells2=(start2.r===end2.r)?Array.from({length:Math.abs(end2.c-start2.c)+1},(_,i)=>({r:start2.r,c:Math.min(start2.c,end2.c)+i})):
                 Array.from({length:Math.abs(end2.r-start2.r)+1},(_,i)=>({r:Math.min(start2.r,end2.r)+i,c:start2.c}));
    return cells1.filter(c1=>cells2.some(c2=>c1.r===c2.r && c1.c===c2.c));
  }

  function drawRoute(start,end,className){
    const color = className==='driverCell'? 'blue' : className==='passengerCell'? 'green' : className;
    if(start.r===end.r) for(let c=Math.min(start.c,end.c);c<=Math.max(start.c,end.c);c++) gridEl.rows[start.r+1].cells[c+1].style.backgroundColor=color;
    else for(let r=Math.min(start.r,end.r);r<=Math.max(start.r,end.r);r++) gridEl.rows[r+1].cells[start.c+1].style.backgroundColor=color;
  }

  function clearGridVisuals(){
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){ const cell=gridEl.rows[r+1].cells[c+1]; cell.style.backgroundColor=''; cell.className=''; }
  }

  function updateGrid(){
    clearGridVisuals();
    if(gridStart) gridEl.rows[gridStart.r+1].cells[gridStart.c+1].classList.add(role==='driver'?'driverCell':'passengerCell');
    if(gridEnd) gridEl.rows[gridEnd.r+1].cells[gridEnd.c+1].classList.add(role==='driver'?'driverCell':'passengerCell');

    if(role==='driver' && gridStart && gridEnd){
      drawRoute(gridStart,gridEnd,myColor||'blue');
      Object.values(usersData).forEach(u=>{
        if(u.role==='passenger' && u.acceptedDriverId==userId && u.start && u.end){
          const pStart=parseCell(u.start), pEnd=parseCell(u.end);
          drawRoute(pStart,pEnd,'green');
          getSharedCells(gridStart,gridEnd,pStart,pEnd).forEach(cell=>gridEl.rows[cell.r+1].cells[cell.c+1].classList.add('sharedCell'));
        }
      });
    }

    if(role==='passenger' && gridStart && gridEnd){
      drawRoute(gridStart,gridEnd,'green');
      if(!acceptedDriverId && matchedDrivers[selectedDriverIndex]){
        const driver=parseCell(matchedDrivers[selectedDriverIndex].start), dEnd=parseCell(matchedDrivers[selectedDriverIndex].end);
        drawRoute(driver,dEnd,matchedDrivers[selectedDriverIndex].color||'blue');
        getSharedCells(gridStart,gridEnd,driver,dEnd).forEach(cell=>gridEl.rows[cell.r+1].cells[cell.c+1].classList.add('sharedCell'));
      }
      if(acceptedDriverId){
        const driver=usersData[acceptedDriverId]; if(driver && driver.start && driver.end){
          const dStart=parseCell(driver.start), dEnd=parseCell(driver.end);
          drawRoute(dStart,dEnd,driver.color||'blue');
          getSharedCells(gridStart,gridEnd,dStart,dEnd).forEach(cell=>gridEl.rows[cell.r+1].cells[cell.c+1].classList.add('sharedCell'));
        }
      }
    }
  }

  function getRandomColor(){ const letters='0123456789ABCDEF'; let color='#'; for(let i=0;i<6;i++) color+=letters[Math.floor(Math.random()*16)]; return color; }

  function assignUserNumber(callback){
    db.ref("meta/nextUserNumber").transaction(current=>(current||0)+1,(err,committed,snapshot)=>{
      if(committed){
        userNumber=snapshot.val(); userId=String(userNumber);
        myColor = role==='driver'? getRandomColor() : 'green';
        db.ref("users/"+userId).set({number:userNumber,role,start:null,end:null,color:myColor,acceptedBy:null});
        updateUsersTable();
        if(callback) callback();
      }
    });
  }

  // ====== MAPA ======
  const map=L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  map.setView([52.23,21.01],13);

function getUserLocation(){
  if(!navigator.geolocation){ return; }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      userLocation = {lat,lng};

      // ðŸ”¹ samo centrowanie mapy â€“ zawsze
      map.setView([lat, lng], 14);

      // marker tworzony dopiero gdy mamy userNumber
      if(userNumber && !myMarker){
        const icon = L.divIcon({
          className:'',
          html:`<div style="background:${myColor};color:#fff;width:26px;height:26px;border-radius:50%;text-align:center;line-height:26px;font-weight:bold;border:2px solid #000;">${userNumber}</div>`,
          iconSize:[26,26],
          iconAnchor:[13,13]
        });
        myMarker = L.marker([lat,lng], {icon}).addTo(map);
      }

      if(myMarker) myMarker.setLatLng([lat,lng]);
    },
    err => { alert("Nie udaÅ‚o siÄ™ pobraÄ‡ lokalizacji"); },
    {
      enableHighAccuracy: true,   // ðŸ”¹ dokÅ‚adniejszy GPS
      timeout: 10000,             // maks. czas oczekiwania 10s
      maximumAge: 0               // nie uÅ¼ywamy starej pozycji z cache
    }
  );
}



  function drawRouteOnMap(startLatLng,endLatLng,color,role){
    if(routeControl) map.removeControl(routeControl);
routeControl = L.Routing.control({
  waypoints: [
    L.latLng(startLatLng.lat, startLatLng.lng), // start (GPS)
    L.latLng(endLatLng.lat, endLatLng.lng)      // cel
  ],
  lineOptions: {
    styles: [{ color: color, weight: 5 }]
  },
  router: L.Routing.osrmv1({
    serviceUrl: 'https://router.project-osrm.org/route/v1',
    profile: role === 'driver' ? 'car' : 'foot'
  }),

  // ðŸ”´ kluczowe:
  createMarker: function(i, wp) {
    if (i === 0) return null;   // âŒ usuÅ„ pinezkÄ™ STARTU
   return L.marker(wp.latLng);     // cel â†’ pinezka
  },

  show: false,
  addWaypoints: false,
  routeWhileDragging: false,
  fitSelectedRoutes: true
}).addTo(map);

  }

map.on('click', e => {
  if (!goalEditMode || !userLocation) return;

  const endLatLng = { lat: e.latlng.lat, lng: e.latlng.lng };
  const color = role === 'driver' ? myColor : 'green';

  // ðŸ”¹ usuwamy goalMarker â€“ nie tworzymy pinezki celu
  // tylko rysujemy trasÄ™ od startu do klikniÄ™tego punktu
  drawRouteOnMap(userLocation, endLatLng, color, role);
});


  // ====== PRZYCISKI ======
  driverBtn.onclick = ()=>{
    role='driver'; document.body.style.backgroundColor="#ddeeff"; driverBtn.disabled=true; passengerBtn.disabled=true;
    assignUserNumber(()=>{ updateUsersTable(); getUserLocation(); });
  };
  passengerBtn.onclick = ()=>{
    role='passenger'; document.body.style.backgroundColor="#ddffdd"; driverBtn.disabled=true; passengerBtn.disabled=true;
    assignUserNumber(()=>{ updateUsersTable(); getUserLocation(); });
  };

  goalBtn.onclick = ()=>{
    goalEditMode=!goalEditMode;
    goalBtn.textContent = goalEditMode ? 'ðŸ’¾ Zapisz cel' : 'ðŸŽ¯ Edytuj cel';
  };

  resetBtn.onclick = ()=>{
    db.ref("users").remove(); db.ref("meta").remove();
    gridStart=null; gridEnd=null; usersData={}; matchedDrivers=[]; selectedDriverIndex=0;
    driverBtn.disabled=false; passengerBtn.disabled=false;
    initGrid();
  };

  // ====== USERS TABLE ======
  function updateUsersHeader(){
    const thead=document.querySelector('#usersTable thead');
    thead.innerHTML=`<tr><th>#</th><th>Kolor</th>${passengersOrder.map(n=>`<th>${n}</th>`).join('')}</tr>`;
  }

  function passengerOnDriverRoute(passenger,driver){
    if(!passenger.start || !driver.start) return false;
    const ps=parseCell(passenger.start), ds=parseCell(driver.start), de=parseCell(driver.end);
    const cells=(ds.r===de.r)?Array.from({length:Math.abs(de.c-ds.c)+1},(_,i)=>({r:ds.r,c:Math.min(ds.c,de.c)+i})):
                 Array.from({length:Math.abs(de.r-ds.r)+1},(_,i)=>({r:Math.min(ds.r,de.r)+i,c:ds.c}));
    return cells.some(c=>c.r===ps.r && c.c===ps.c);
  }

  function updateUsersTable(){
    updateUsersHeader(); usersTableBody.innerHTML='';
    const passengers=Object.values(usersData).filter(u=>u.role==='passenger');
    const drivers=Object.values(usersData).filter(u=>u.role==='driver');
    drivers.forEach(driver=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${driver.number}</td><td style="background:${driver.color||''}"></td>${passengersOrder.map(pNum=>{const p=passengers.find(x=>x.number===pNum); return `<td>${p && passengerOnDriverRoute(p,driver)?'O':''}</td>`;}).join('')}`;
      usersTableBody.appendChild(tr);
    });
  }

  db.ref("users").on('value',snapshot=>{
    usersData=snapshot.val()||{};
    const passengers=Object.values(usersData).filter(u=>u.role==='passenger' && typeof u.number==='number').sort((a,b)=>a.number-b.number);
    passengersOrder=passengers.map(p=>p.number);
    Object.entries(usersData).forEach(([id,u])=>{if(u.role==='driver') driverColors[id]=u.color||getRandomColor();});
    updateUsersTable();
    updateGrid();
  });

// ðŸ”¹ Sprawdzamy kierowcÃ³w dla pasaÅ¼era
function updateMatchedDrivers() {
  if(role!=='passenger' || !gridStart) return;

  matchedDrivers = Object.entries(usersData)
    .filter(([id,u])=>u.role==='driver' && !u.acceptedBy && u.start && u.end)
    .map(([id,u])=>({id, start:u.start, end:u.end, color:u.color||'blue'}))
    .filter(d=>passengerOnDriverRoute({start:`${gridStart.r},${gridStart.c}`}, d));

  selectedDriverIndex = 0;
  updateMapDriverRoute();
}

// ðŸ”¹ Rysujemy trasÄ™ aktualnego kierowcy u pasaÅ¼era
let driverLine=null, overlapLine=null;
function updateMapDriverRoute() {
  if(driverLine) map.removeLayer(driverLine);
  if(overlapLine) map.removeLayer(overlapLine);

  if(!matchedDrivers[selectedDriverIndex]) return;
  const driver = matchedDrivers[selectedDriverIndex];
  const startLatLng = gridToLatLng(parseCell(driver.start));
  const endLatLng = gridToLatLng(parseCell(driver.end));
  driverLine = L.polyline([startLatLng, endLatLng], {color: driver.color, weight:5}).addTo(map);

  // ðŸ”´ wspÃ³lne odcinki (na razie u pasaÅ¼era)
  const sharedCells = getSharedCells(gridStart, gridEnd, parseCell(driver.start), parseCell(driver.end));
  if(sharedCells.length) {
    const points = sharedCells.map(c=>gridToLatLng(c));
    overlapLine = L.polyline(points, {color:'red', weight:7}).addTo(map);
  }
}

// ðŸ”¹ Przeliczanie tras po zmianie uÅ¼ytkownikÃ³w
db.ref("users").on('value',snapshot=>{
  usersData=snapshot.val()||{};
  updateUsersTable();
  updateGrid();
  updateMatchedDrivers();
});

// ðŸ”¹ PrzeglÄ…danie kierowcÃ³w
nextDriverBtn.onclick = ()=>{
  if(matchedDrivers.length===0) return;
  selectedDriverIndex = (selectedDriverIndex+1)%matchedDrivers.length;
  updateMapDriverRoute();
};
prevDriverBtn.onclick = ()=>{
  if(matchedDrivers.length===0) return;
  selectedDriverIndex = (selectedDriverIndex-1+matchedDrivers.length)%matchedDrivers.length;
  updateMapDriverRoute();
};

// ðŸ”¹ Akceptacja trasy
acceptBtn.onclick = ()=>{
  if(matchedDrivers[selectedDriverIndex]){
    acceptedDriverId = matchedDrivers[selectedDriverIndex].id;
    db.ref(`users/${userId}/acceptedBy`).set(acceptedDriverId);
    db.ref(`users/${acceptedDriverId}/acceptedBy`).set(userId); // Å¼eby kierowca wiedziaÅ‚
    updateMapDriverRoute();
    updateGrid();
  }
};


  // ====== START ======
initGrid();
getUserLocation();
</script>
</body>
</html>
