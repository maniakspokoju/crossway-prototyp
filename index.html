<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>CROSSWAY – GRID TEST</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #222;
    color: #fff;
  }

  body.driver { background: #1f3a5f; }
  body.passenger { background: #3a1f3a; }

  #top {
    padding: 10px;
    display: flex;
    gap: 10px;
  }

  button {
    padding: 10px 14px;
    font-size: 14px;
    cursor: pointer;
  }

  button.active {
    outline: 3px solid yellow;
  }

  #main {
    display: flex;
    gap: 20px;
    padding: 10px;
  }

  #grid {
    display: grid;
    grid-template-columns: repeat(9, 40px);
    grid-template-rows: repeat(9, 40px);
    gap: 2px;
  }

  .cell {
    background: #444;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
  }

  .label {
    background: #111;
    font-weight: bold;
  }

  .start { background: #2ecc71; }
  .end { background: #e74c3c; }
  .route { background: #3498db; }
  .overlap { background: #f1c40f; }

  table {
    border-collapse: collapse;
    font-size: 13px;
  }

  td, th {
    border: 1px solid #555;
    padding: 4px 6px;
  }
</style>
</head>

<body>

<div id="top">
  <button id="driverBtn">DRIVER</button>
  <button id="passengerBtn">PASSENGER</button>
</div>

<div id="main">
  <div id="grid"></div>

  <div>
    <h3>Użytkownicy</h3>
    <table id="usersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Rola</th>
          <th>Start</th>
          <th>Cel</th>
          <th>Match</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ================= STATE ================= */

const userId = Math.random().toString(36).slice(2, 8);
let role = null;
let phase = "start"; // start | end

const users = {};
users[userId] = { id: userId };

/* ================= UI ================= */

const driverBtn = document.getElementById("driverBtn");
const passengerBtn = document.getElementById("passengerBtn");
const grid = document.getElementById("grid");
const tableBody = document.querySelector("#usersTable tbody");

/* ================= ROLE ================= */

driverBtn.onclick = () => setRole("driver");
passengerBtn.onclick = () => setRole("passenger");

function setRole(r) {
  if (role) return; // BLOKADA zmiany roli
  role = r;
  users[userId].role = r;

  document.body.className = r;
  driverBtn.classList.toggle("active", r === "driver");
  passengerBtn.classList.toggle("active", r === "passenger");
}

/* ================= GRID ================= */

const letters = ["", "A","B","C","D","E","F","G","H"];

function buildGrid() {
  grid.innerHTML = "";

  for (let y = 8; y >= 0; y--) {
    for (let x = 0; x <= 8; x++) {
      const cell = document.createElement("div");
      cell.className = "cell";

      if (y === 0 && x === 0) cell.classList.add("label");
      else if (y === 0) {
        cell.textContent = letters[x];
        cell.classList.add("label");
      }
      else if (x === 0) {
        cell.textContent = y;
        cell.classList.add("label");
      }
      else {
        const pos = letters[x] + y;
        cell.dataset.pos = pos;
        cell.onclick = () => onCellClick(pos);
      }

      grid.appendChild(cell);
    }
  }
}

buildGrid();

/* ================= CLICK LOGIC ================= */

function onCellClick(pos) {
  if (!role) return;

  if (phase === "start") {
    users[userId].start = pos;
    phase = "end";
  } else {
    if (!validLine(users[userId].start, pos)) return alert("Tylko linia prosta!");
    users[userId].end = pos;
    users[userId].route = buildRoute(users[userId].start, pos);
    phase = "done";
  }

  render();
}

/* ================= ROUTES ================= */

function validLine(a, b) {
  return a[0] === b[0] || a[1] === b[1];
}

function buildRoute(a, b) {
  const route = [];
  const colA = a[0], colB = b[0];
  const rowA = +a[1], rowB = +b[1];

  if (colA === colB) {
    const [min, max] = [rowA, rowB].sort((a,b)=>a-b);
    for (let r = min; r <= max; r++) route.push(colA + r);
  } else {
    const [min, max] = [colA.charCodeAt(0), colB.charCodeAt(0)].sort((a,b)=>a-b);
    for (let c = min; c <= max; c++) route.push(String.fromCharCode(c) + rowA);
  }
  return route;
}

/* ================= MATCH ================= */

function checkMatch(passenger, driver) {
  if (!driver.route || !passenger.start) return false;
  return driver.route.includes(passenger.start);
}

/* ================= RENDER ================= */

function render() {
  document.querySelectorAll(".cell").forEach(c => {
    c.classList.remove("start","end","route","overlap");
  });

  Object.values(users).forEach(u => {
    if (!u.route) return;
    u.route.forEach(p => mark(p, "route"));
    mark(u.start, "start");
    mark(u.end, "end");
  });

  tableBody.innerHTML = "";
  Object.values(users).forEach(u => {
    let match = "";
    if (u.role === "passenger") {
      match = Object.values(users)
        .filter(x => x.role === "driver" && checkMatch(u,x))
        .map(x => x.id)
        .join(",");
    }

    tableBody.innerHTML += `
      <tr>
        <td>${u.id}</td>
        <td>${u.role || ""}</td>
        <td>${u.start || ""}</td>
        <td>${u.end || ""}</td>
        <td>${match}</td>
      </tr>`;
  });
}

function mark(pos, cls) {
  const cell = [...document.querySelectorAll(".cell")]
    .find(c => c.dataset.pos === pos);
  if (cell) cell.classList.add(cls);
}
</script>

</body>
</html>
