<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
    font-family: sans-serif;
    margin: 10px;
}

/* MAPA */
#map {
    height: 1000px;
    margin-top: 20px;
    display: none;
}

/* SEKCJE FORMULARZY */
#driverDestinationDiv,
#passengerDestinationDiv {
    display: none;
    margin-top: 20px;
}

/* INPUTY */
input {
    width: 120px;
    height: 50px;
    font-size: 22px;
    margin-right: 10px;
    text-align: center;
}

/* ===== DUÅ»E PRZYCISKI (4â€“6x) ===== */
button {
    font-size: 26px;
    padding: 20px 30px;
    margin: 10px 5px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
}

/* LEPSZA CZYTELNOÅšÄ† RÃ“L */
#driverBtn {
    background-color: #2f6fff;
    color: white;
}

#passengerBtn {
    background-color: #2fbf6f;
    color: white;
}

/* EFEKT DOTYKOWY */
button:active {
    transform: scale(0.97);
}
</style>
</head>

<body>
																<h1>Crossway â€“ fundament 3.7</h1>

<button id="driverBtn">Driver</button>
<button id="passengerBtn">Passenger</button>
<p id="role"></p>
<button id="modeBtn" style="display:none;">Tryb A</button>

<button id="acceptBtn" style="display:none; background:#ff5722; color:white;">
  Akceptuj trasÄ™
</button>


<div id="driverDestinationDiv">
<h3>Cel kierowcy</h3>

<!-- <input id="driverDestLat" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->
<!-- <input id="driverDestLng" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->

<button id="saveDriverDestinationBtn">Edytuj cel</button>
</div>

<div id="passengerDestinationDiv">
<h3>Cel pasaÅ¼era</h3>

<!-- <input id="destLat" placeholder="###" step="1" inputmode="numeric"> -->			<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->
<!-- <input id="destLng" placeholder="###" step="1" inputmode="numeric"> -->			<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->

<button id="saveDestinationBtn">Edytuj cel</button>
</div>

<div id="passengerStartDiv" style="margin-top:15px; display:none;">
  <h3>Start pasaÅ¼era (zmiana dla testÃ³w)</h3>

<!-- <input type="number" id="startLat" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->
<!-- <input type="number" id="startLng" placeholder="###" step="1" inputmode="numeric"> -->		<!-- tu sÄ… zakomentowane pola do wpisywania lokalizacji -->

  <button id="saveStartBtn">Edytuj start</button>
  </div>

<div id="savedLocations" style="margin-top:10px; font-weight:bold;">
  <p id="driverSavedInfo" style="color:#2f6fff;"></p>
  <p id="passengerSavedInfo" style="color:#2fbf6f;"></p>
</div>

<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();
db.ref("session").remove();

let currentMode = "A"; // A = przeciÄ™cia, B = optymalny dystans
let accepted = false;

let currentRole = null; // "driver" | "passenger"

// STANY EDYCJI
let editingDriverDestination = false;
let editingPassengerDestination = false;
let editingPassengerStart = false;

// Zmienna przechowujÄ…ca wybrany punkt z mapy
let selectedPoint = null;


/* ================= MAP ================= */
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const driverLine = L.polyline([], { color: "blue", weight: 5 }).addTo(map);
const passengerLine = L.polyline([], { color: "green", weight: 5 }).addTo(map);
const overlapLine = L.polyline([], { color: "red", weight: 7 }).addTo(map);

/* ================= MARKERY ================= */

// Ikony liter K i P
const iconK = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2f6fff'>K</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

const iconP = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2fbf6f'>P</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

// Markery
const driverStartMarker = L.marker([0,0], { icon: iconK }).addTo(map);
const passengerStartMarker = L.marker([0,0], { icon: iconP }).addTo(map);

const driverEndMarker = L.marker([0,0]).addTo(map);
const passengerEndMarker = L.marker([0,0]).addTo(map);


/* ================= UTILS ================= */
const TOLERANCE_METERS = 30;

function distanceMeters(a, b) {
  const R = 6371000;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLng = (b[1]-a[1]) * Math.PI/180;
  const x = dLng * Math.cos((a[0]+b[0])/2 * Math.PI/180);
  return Math.sqrt(dLat*dLat + x*x) * R;
}

function findClosestIndex(point, path) {
  let min = Infinity, idx = -1;
  path.forEach((p, i) => {
    const d = distanceMeters(point, p);
    if (d < min) { min = d; idx = i; }
  });
  return min <= TOLERANCE_METERS ? idx : -1;
}

// ObsÅ‚uga klikniÄ™cia na mapie
map.on('click', function(e) {
  // JeÅ›li Å¼aden tryb edycji nie jest aktywny, nic nie rÃ³b
  if (!editingDriverDestination && !editingPassengerDestination && !editingPassengerStart) return;

  // Zapisujemy klikniÄ™ty punkt
  selectedPoint = [e.latlng.lat, e.latlng.lng];

  // PodglÄ…d znacznika na mapie
  if (editingDriverDestination) driverEndMarker.setLatLng(selectedPoint);
  if (editingPassengerDestination) passengerEndMarker.setLatLng(selectedPoint);
  if (editingPassengerStart) passengerStartMarker.setLatLng(selectedPoint);
});


function findBestExitIndex(driverPath, passengerDestination, startIdx) {
  let bestIdx = startIdx;
  let bestDistance = Infinity;

  for (let i = startIdx; i < driverPath.length; i++) {
    const d = distanceMeters(driverPath[i], passengerDestination);
    if (d < bestDistance) {
      bestDistance = d;
      bestIdx = i;
    }
  }

  return bestIdx;
}


/* ================= OSRM ================= */
async function route(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

db.ref("session/accepted").on("value", snap => {
  accepted = snap.val() === true;
  if (accepted) lockFormsAfterAccept();
});


db.ref("session/accepted").on("value", snap => {
  const accepted = snap.val() === true;

  if (accepted) {
    // Blokujemy wszystkie guziki
    saveDriverDestinationBtn.disabled = true;
    saveDestinationBtn.disabled = true;
    saveStartBtn.disabled = true;

    // Zmieniamy style na szare
    saveDriverDestinationBtn.style.opacity = "0.4";
    saveDestinationBtn.style.opacity = "0.4";
    saveStartBtn.style.opacity = "0.4";

    // WyÅ‚Ä…czamy edycjÄ™
    editingDriverDestination = false;
    editingPassengerDestination = false;
    editingPassengerStart = false;
  }
});



/* ================= MAIN ================= */
async function update() {
  overlapLine.setLatLngs([]);

  const ds = (await db.ref("session/driver").once("value")).val();
  const ps = (await db.ref("session/passenger").once("value")).val();if (
  !ds?.currentLocation ||
  !ds?.destination ||
  !ps?.currentLocation ||
  !ps?.destination
) return;


console.log("DRIVER:", ds);
console.log("PASSENGER:", ps);


  const dPath = await route(
    [ds.currentLocation.latitude, ds.currentLocation.longitude],
    [ds.destination.latitude, ds.destination.longitude]
  );

  const pPath = await route(
    [ps.currentLocation.latitude, ps.currentLocation.longitude],
    [ps.destination.latitude, ps.destination.longitude]
  );

driverLine.setLatLngs(dPath);

if (dPath.length > 0) {
  map.fitBounds(dPath, { padding: [40, 40] });
}

// kierowca widzi wiÄ™cej dopiero po akceptacji
if (accepted || currentRole === "passenger") {
  passengerLine.setLatLngs(pPath);
} else {
  passengerLine.setLatLngs([]);
}

/* ===== STARTY ===== */
driverStartMarker.setLatLng(dPath[0]);

if (accepted || currentRole === "passenger") {
  passengerStartMarker.setLatLng(pPath[0]);
} else {
  passengerStartMarker.setLatLng([0, 0]);
}

/* ===== CELE ===== */
driverEndMarker.setLatLng(dPath[dPath.length - 1]);

if (accepted || currentRole === "passenger") {
  passengerEndMarker.setLatLng(pPath[pPath.length - 1]);
} else {
  passengerEndMarker.setLatLng([0, 0]);
}



const startPassenger = [ps.currentLocation.latitude, ps.currentLocation.longitude];
const startIdx = findClosestIndex(startPassenger, dPath);
if (startIdx === -1) return;

let endIdx = -1;

if (currentMode === "A") {
  const intersections = [];
  dPath.forEach((dp, i) => {
    pPath.forEach(pp => {
      if (distanceMeters(dp, pp) <= TOLERANCE_METERS) intersections.push(i);
    });
  });

  const unique = [...new Set(intersections)].filter(i => i >= startIdx);
  if (unique.length < 2) return;

  endIdx = Math.max(...unique);
}

if (currentMode === "B") {
  const passengerDest = [ps.destination.latitude, ps.destination.longitude];
  endIdx = findBestExitIndex(dPath, passengerDest, startIdx);
}

// ===== RYSOWANIE TRASY TRZECIEJ =====
if (
  (accepted || currentRole === "passenger") &&
  startIdx !== -1 &&
  endIdx !== -1
) {
  overlapLine.setLatLngs(dPath.slice(startIdx, endIdx + 1));
} else {
  overlapLine.setLatLngs([]);
}

}

db.ref("session").on("value", () => {
  update();
  updateRoleAvailability();
});


/* ================= ROLE ================= */
function assign(role) {
  currentRole = role;

  document.getElementById("map").style.display = "block";

  db.ref("session/" + role).set({ role });

  navigator.geolocation.getCurrentPosition(p => {
    db.ref(`session/${role}/currentLocation`).set({
      latitude: p.coords.latitude,
      longitude: p.coords.longitude
    });
  });

  // UI
  modeBtn.style.display = role === "passenger" ? "inline-block" : "none";

  if (role === "driver") driverDestinationDiv.style.display = "block";
  if (role === "passenger") passengerDestinationDiv.style.display = "block";
  if (role === "passenger") passengerStartDiv.style.display = "block";

if (role === "passenger") {
  modeBtn.style.display = "inline-block";
  acceptBtn.style.display = "inline-block";
}

}


driverBtn.onclick = ()=>assign("driver");
passengerBtn.onclick = ()=>assign("passenger");

/* ================= BLOKADA RÃ“L ================= */

function updateRoleAvailability() {
  db.ref("session").once("value").then(snapshot => {
    const data = snapshot.val() || {};

    // DRIVER
    if (data.driver && data.driver.role === "driver") {
      driverBtn.disabled = true;
      driverBtn.style.opacity = "0.4";
      driverBtn.innerText = "Driver zajÄ™ty";
    } else {
      driverBtn.disabled = false;
      driverBtn.style.opacity = "1";
      driverBtn.innerText = "Driver";
    }

    // PASSENGER
    if (data.passenger && data.passenger.role === "passenger") {
      passengerBtn.disabled = true;
      passengerBtn.style.opacity = "0.4";
      passengerBtn.innerText = "Passenger zajÄ™ty";
    } else {
      passengerBtn.disabled = false;
      passengerBtn.style.opacity = "1";
      passengerBtn.innerText = "Passenger";
    }
  });
}



saveDriverDestinationBtn.onclick = ()=>{
  db.ref("session/driver/destination").set({
    latitude: 52.1 + driverDestLat.value/10000,
    longitude: 19.9 + driverDestLng.value/10000
  });
};

saveDestinationBtn.onclick = ()=>{
  db.ref("session/passenger/destination").set({
    latitude: 52.1 + destLat.value/10000,
    longitude: 19.9 + destLng.value/10000
  });
};

// start pasaÅ¼era
// saveStartBtn.addEventListener("click", () => {
 // const latSuffix = startLat.value.trim();
 // const lngSuffix = startLng.value.trim();

 // if(latSuffix.length === 3 && lngSuffix.length === 3){
  //  const lat = 52.1 + parseInt(latSuffix)/10000;
  //  const lng = 19.9 + parseInt(lngSuffix)/10000;

 //   db.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng })
 //     .then(() => console.log("Nowa lokalizacja startowa pasaÅ¼era zapisana:", lat, lng))
 //     .catch(err => console.error(err));
//  } else {
//    alert("WprowadÅº dokÅ‚adnie 3 cyfry dla szerokoÅ›ci i dÅ‚ugoÅ›ci!");
//  }
// });





// Kierowca â€“ cel
saveDriverDestinationBtn.onclick = () => {
  if (!editingDriverDestination) {
    // WÅ‚Ä…cz tryb edycji
    editingDriverDestination = true;
    saveDriverDestinationBtn.innerText = "Zapisz cel";
    return;
  }

  // Tryb zapisu
  if (selectedPoint) {
    db.ref("session/driver/destination").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingDriverDestination = false;
  saveDriverDestinationBtn.innerText = "Edytuj cel";
  selectedPoint = null;
};

// PasaÅ¼er â€“ cel
saveDestinationBtn.onclick = () => {
  if (!editingPassengerDestination) {
    editingPassengerDestination = true;
    saveDestinationBtn.innerText = "Zapisz cel";
    return;
  }

  if (selectedPoint) {
    db.ref("session/passenger/destination").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingPassengerDestination = false;
  saveDestinationBtn.innerText = "Edytuj cel";
  selectedPoint = null;
};

// PasaÅ¼er â€“ start
saveStartBtn.onclick = () => {
  if (!editingPassengerStart) {
    editingPassengerStart = true;
    saveStartBtn.innerText = "Zapisz start";
    return;
  }

  if (selectedPoint) {
    db.ref("session/passenger/currentLocation").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingPassengerStart = false;
  saveStartBtn.innerText = "Edytuj start";
  selectedPoint = null;
};


const modeBtn = document.getElementById("modeBtn");

modeBtn.onclick = () => {
  currentMode = currentMode === "A" ? "B" : "A";
  modeBtn.innerText = "Tryb " + currentMode;
  console.log("Aktualny tryb:", currentMode);
  update(); // ðŸ”´ TO BYÅ BRAKUJÄ„CY ELEMENT
};

const acceptBtn = document.getElementById("acceptBtn");

acceptBtn.onclick = () => {
  db.ref("session/accepted").set(true);
  lockFormsAfterAccept();
};


function lockFormsAfterAccept() {
  const inputs = document.querySelectorAll(
    "#driverDestinationDiv input, #passengerDestinationDiv input, #passengerStartDiv input"
  );
  const buttons = document.querySelectorAll(
    "#driverDestinationDiv button, #passengerDestinationDiv button, #passengerStartDiv button"
  );

  inputs.forEach(i => i.disabled = true);
  buttons.forEach(b => {
    b.disabled = true;
    b.style.opacity = "0.4";
  });
}



</script>
</body>
</html>