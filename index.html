<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<title>Crossway</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
body {
    font-family: sans-serif;
    margin: 10px;
    transition: background-color 0.3s ease;
}


/* MAPA */
#map {
    height: 1000px;
    margin-top: 20px;
}

/* SEKCJE FORMULARZY */
#driverDestinationDiv,
#passengerDestinationDiv {
    display: none;
    margin-top: 20px;
}

/* INPUTY */
input {
    width: 120px;
    height: 50px;
    font-size: 22px;
    margin-right: 10px;
    text-align: center;
}

/* ===== DUÅ»E PRZYCISKI (4â€“6x) ===== */
button {
    font-size: 26px;
    padding: 20px 30px;
    margin: 10px 5px;
    border-radius: 14px;
    border: none;
    cursor: pointer;
}

/* LEPSZA CZYTELNOÅšÄ† RÃ“L */
#driverBtn {
    background-color: #2f6fff;
    color: white;
}

#passengerBtn {
    background-color: #2fbf6f;
    color: white;
}

/* EFEKT DOTYKOWY */
button:active {
    transform: scale(0.97);
}

/* ===== MOBILE LAYOUT ===== */
html, body {
  height: 100%;
  margin: 0;
}

#roleBar {
  display: flex;
  width: 100%;
}

#roleBar button {
  width: 50%;
  height: 80px;
  font-size: 28px;
  border-radius: 0;
}

/* MAPA ZAWSZE NA DOLE */
#map {
  height: calc(100vh - 80px);
}

#driverDestinationDiv button {
  width: 95%;
}

#passengerControls button {
  font-size: 24px;
  padding: 15px;
  border-radius: 12px;
  cursor: pointer;
}

#passengerControls button:active {
  transform: scale(0.97);
}


#usersTable {
  border-collapse: collapse;
  margin-top: 20px;
}

#usersTable th, #usersTable td {
  padding: 8px;
  border: 1px solid #333;
}

#usersTable tr:nth-child(even) {
  background-color: #f0f0f0;
}


</style>
</head>

<body>
																<h1>Crossway â€“ fundament 5.1.9</h1>

<div id="roleBar">
  <button id="driverBtn">Driver</button>
  <button id="passengerBtn">Passenger</button>
</div>

<p id="role"></p>

<!-- PANEL PASAÅ»ERA -->
<div id="passengerControls" style="display:none; margin-top:10px;">
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <button id="modeBtn" style="flex:5;">Tryb A</button>
    <button id="acceptBtn" style="flex:8; background:#ff5722; color:white;">Akceptuj trasÄ™</button>
  </div>
  <div style="display:flex; gap:10px; margin-bottom:10px;">
    <button id="prevDriverBtn" style="flex:1;">â—€ Cofnij</button>
    <button id="nextDriverBtn" style="flex:1;">Dalej â–¶</button>
  </div>
  <div style="display:flex; gap:10px;">
    <button id="saveDestinationBtn" style="flex:1;">Edytuj cel</button>
    <button id="saveStartBtn" style="flex:1;">Edytuj start</button>
  </div>
</div>


<div id="driverDestinationDiv">
<button id="saveDriverDestinationBtn">Edytuj cel</button>
</div>



<div id="savedLocations" style="margin-top:10px; font-weight:bold;">
  <p id="driverSavedInfo" style="color:#2f6fff;"></p>
  <p id="passengerSavedInfo" style="color:#2fbf6f;"></p>
</div>

<!-- TABELA UÅ»YTKOWNIKÃ“W -->
<h2>UÅ¼ytkownicy w sesji</h2>
<table id="usersTable" border="1" style="width:100%; text-align:center;">
  <thead>
    <tr>
      <th>User ID</th>
      <th>Rola</th>
      <th>Current Location</th>
      <th>Destination</th>
      <th>Akceptacja</th>
    </tr>
  </thead>
  <tbody>
    <!-- wiersze bÄ™dÄ… generowane dynamicznie przez JS -->
  </tbody>
</table>


<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>


function showStartMarker(role, lat, lng) {
  const latlng = [lat, lng];
  if (role === "driver") {
    driverStartMarker.setLatLng(latlng); // pokaÅ¼ D
  } 
  if (role === "passenger") {
    passengerStartMarker.setLatLng(latlng); // pokaÅ¼ P
  }
}



/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
  databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
});
const db = firebase.database();
db.ref("session").remove();

// nasÅ‚uchiwanie wszystkich uÅ¼ytkownikÃ³w w sesji
db.ref("session/users").on("value", snapshot => {
  const users = snapshot.val() || {};
  updateUsersTable(users);
});


// Unikalny identyfikator dla kaÅ¼dego uÅ¼ytkownika (losowy)
const userId = 'user_' + Math.random().toString(36).substr(2, 9);

let currentMode = "A"; // A = przeciÄ™cia, B = optymalny dystans
let accepted = false;
let acceptLocked = false; // ðŸ”’ lokalna blokada guzika


let currentRole = null; // "driver" | "passenger"

// STANY EDYCJI
let editingDriverDestination = false;
let editingPassengerDestination = false;
let editingPassengerStart = false;

// Zmienna przechowujÄ…ca wybrany punkt z mapy
let selectedPoint = null;

function setBackgroundFromRoleButton(button) {
  const color = getComputedStyle(button).backgroundColor;
  document.body.style.backgroundColor = color;
}



/* ================= MAP ================= */
const map = L.map("map").setView([52.1, 19.9], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const driverLine = L.polyline([], { color: "blue", weight: 5 }).addTo(map);
const passengerLine = L.polyline([], { color: "green", weight: 5 }).addTo(map);
const overlapLine = L.polyline([], { color: "red", weight: 7 }).addTo(map);

/* ================= MARKERY ================= */

// Ikony liter K i P
const iconK = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2f6fff'>K</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

const iconP = L.divIcon({
  html: "<div style='font-size:26px;font-weight:bold;color:#2fbf6f'>P</div>",
  className: "",
  iconSize: [30, 30],
  iconAnchor: [15, 15]
});

// Markery
const driverStartMarker = L.marker([0,0], { icon: iconK }).addTo(map);
const passengerStartMarker = L.marker([0,0], { icon: iconP }).addTo(map);

const driverEndMarker = L.marker([0,0]).addTo(map);
const passengerEndMarker = L.marker([0,0]).addTo(map);


/* ================= UTILS ================= */
const TOLERANCE_METERS = 60;

function distanceMeters(a, b) {
  const R = 6371000;
  const dLat = (b[0]-a[0]) * Math.PI/180;
  const dLng = (b[1]-a[1]) * Math.PI/180;
  const x = dLng * Math.cos((a[0]+b[0])/2 * Math.PI/180);
  return Math.sqrt(dLat*dLat + x*x) * R;
}

function findClosestIndex(point, path) {
  let min = Infinity, idx = -1;
  path.forEach((p, i) => {
    const d = distanceMeters(point, p);
    if (d < min) { min = d; idx = i; }
  });
  return min <= TOLERANCE_METERS ? idx : -1;
}

// ObsÅ‚uga klikniÄ™cia na mapie
map.on('click', function(e) {
  // JeÅ›li Å¼aden tryb edycji nie jest aktywny, nic nie rÃ³b
  if (!editingDriverDestination && !editingPassengerDestination && !editingPassengerStart) return;

  // Zapisujemy klikniÄ™ty punkt
  selectedPoint = [e.latlng.lat, e.latlng.lng];

  // PodglÄ…d znacznika na mapie
  if (editingDriverDestination) driverEndMarker.setLatLng(selectedPoint);
  if (editingPassengerDestination) passengerEndMarker.setLatLng(selectedPoint);
  if (editingPassengerStart) passengerStartMarker.setLatLng(selectedPoint);
});


function findBestExitIndex(driverPath, passengerDestination, startIdx) {
  let bestIdx = startIdx;
  let bestDistance = Infinity;

  for (let i = startIdx; i < driverPath.length; i++) {
    const d = distanceMeters(driverPath[i], passengerDestination);
    if (d < bestDistance) {
      bestDistance = d;
      bestIdx = i;
    }
  }

  return bestIdx;
}


/* ================= OSRM ================= */
async function route(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a[1]},${a[0]};${b[1]},${b[0]}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  return r.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
}

db.ref("session/accepted").on("value", snap => {
  accepted = snap.val() === true;
  if (accepted) lockFormsAfterAccept();
});



/* ================= MAIN ================= */
async function update() {
  // czyÅ›cimy linie (bez ruszania mapy)
  driverLine.setLatLngs([]);
  passengerLine.setLatLngs([]);
  overlapLine.setLatLngs([]);

  const usersSnap = await db.ref("session/users").once("value");
  const users = usersSnap.val() || {};

  const driver = Object.values(users).find(u => u.role === "driver");
  const passenger = Object.values(users).find(u => u.role === "passenger");

  // â— najpierw sprawdzamy istnienie rÃ³l
  if (!driver || !passenger) return;

  // â— potem kompletnoÅ›Ä‡ danych
  if (
    !driver.currentLocation ||
    !driver.destination ||
    !passenger.currentLocation ||
    !passenger.destination
  ) return;

  let dPath = null;
  let pPath = null;

  /* ================= TRASA KIEROWCY (ZAWSZE) ================= */
  dPath = await route(
    [driver.currentLocation.latitude, driver.currentLocation.longitude],
    [driver.destination.latitude, driver.destination.longitude]
  );
  driverLine.setLatLngs(dPath);
  if (dPath.length) {
    driverStartMarker.setLatLng(dPath[0]);
    driverEndMarker.setLatLng(dPath.at(-1));
  }

  /* ================= TRASA PASAÅ»ERA ================= */
  pPath = await route(
    [passenger.currentLocation.latitude, passenger.currentLocation.longitude],
    [passenger.destination.latitude, passenger.destination.longitude]
  );
  passengerLine.setLatLngs(pPath);
  if (pPath.length) {
    passengerStartMarker.setLatLng(pPath[0]);
    passengerEndMarker.setLatLng(pPath.at(-1));
  }

  /* ================= TRASA WSPÃ“LNA ================= */
  let overlapExists = false; // ðŸ”¹ flaga do guzika akceptacji

  if (dPath && pPath) {
    const startPassenger = [
      passenger.currentLocation.latitude,
      passenger.currentLocation.longitude
    ];
    const startIdx = findClosestIndex(startPassenger, dPath);

    if (startIdx !== -1) {
      let endIdx = -1;

      if (currentMode === "A") {
        const hits = [];
        dPath.forEach((dp, i) => pPath.forEach(pp => {
          if (distanceMeters(dp, pp) <= TOLERANCE_METERS) hits.push(i);
        }));
        const valid = [...new Set(hits)].filter(i => i >= startIdx);
        if (valid.length >= 2) endIdx = Math.max(...valid);
      }

      if (currentMode === "B") {
        const passengerDest = [
          passenger.destination.latitude,
          passenger.destination.longitude
        ];
        endIdx = findBestExitIndex(dPath, passengerDest, startIdx);
      }

      if (endIdx !== -1) {
        overlapLine.setLatLngs(dPath.slice(startIdx, endIdx + 1));
        overlapExists = true; // ðŸ”¹ jest wspÃ³lna trasa
      }
    }
  }

  // ðŸ”¹ Aktywacja/dezaktywacja przycisku Akceptuj trasÄ™
  if (!acceptLocked) {
    acceptBtn.disabled = !overlapExists;
    acceptBtn.style.opacity = overlapExists ? "1" : "0.4";
  }
}
 // koniec funkcji update()


// FUNKCJA DO AKTUALIZACJI TABELI
function updateUsersTable(usersData) {
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = ""; // czyÅ›cimy stare wiersze

  Object.entries(usersData).forEach(([uid, user]) => {
    const tr = document.createElement("tr");

    // User ID
    const tdId = document.createElement("td");
    tdId.textContent = uid;
    tr.appendChild(tdId);

    // Rola
    const tdRole = document.createElement("td");
    tdRole.textContent = user.role || "-";
    tr.appendChild(tdRole);

    // Current Location
    const tdCurrent = document.createElement("td");
    if (user.currentLocation) {
      tdCurrent.textContent = `${user.currentLocation.latitude.toFixed(5)}, ${user.currentLocation.longitude.toFixed(5)}`;
    } else {
      tdCurrent.textContent = "-";
    }
    tr.appendChild(tdCurrent);

    // Destination
    const tdDest = document.createElement("td");
    if (user.destination) {
      tdDest.textContent = `${user.destination.latitude.toFixed(5)}, ${user.destination.longitude.toFixed(5)}`;
    } else {
      tdDest.textContent = "-";
    }
    tr.appendChild(tdDest);

    // Akceptacja
    const tdAccepted = document.createElement("td");
    tdAccepted.textContent = user.accepted ? "TAK" : "NIE";
    tr.appendChild(tdAccepted);

    tbody.appendChild(tr);
  });
}


db.ref("session").on("value", () => {
  update();
  updateRoleAvailability();
});


/* ================= ROLE ================= */
function assign(role) {
  const firstTimeChoosing = !currentRole; // pierwszy wybÃ³r

  if (firstTimeChoosing) {
    currentRole = role;

    // ðŸ”¹ nowy zapis w Firebase: lista uÅ¼ytkownikÃ³w
    db.ref(`session/users/${userId}`).set({
      role: role,
      currentLocation: null,
      destination: null,
      accepted: false
    });
  }

  // Pobranie aktualnej lokalizacji
  navigator.geolocation.getCurrentPosition(p => {
    const lat = p.coords.latitude;
    const lng = p.coords.longitude;

    // ðŸ”¹ zapis lokalizacji uÅ¼ytkownika w liÅ›cie
    db.ref(`session/users/${userId}/currentLocation`).set({ latitude: lat, longitude: lng });

    // Ustawienie markera startowego od razu na mapie
    if (role === "driver") driverStartMarker.setLatLng([lat, lng]);
    if (role === "passenger") passengerStartMarker.setLatLng([lat, lng]);
  });

  // UI lokalne â€“ guziki stajÄ… siÄ™ nieaktywne
  driverBtn.disabled = true;
  driverBtn.style.opacity = "0.4";
  passengerBtn.disabled = true;
  passengerBtn.style.opacity = "0.4";

  // Pokazanie odpowiedniego panelu
  if (role === "driver") driverDestinationDiv.style.display = "block";
  if (role === "passenger") document.getElementById("passengerControls").style.display = "block";
}


driverBtn.onclick = () => {
  setBackgroundFromRoleButton(driverBtn);
  assign("driver");
};

passengerBtn.onclick = () => {
  setBackgroundFromRoleButton(passengerBtn);
  assign("passenger");
};


/* ================= BLOKADA RÃ“L ================= */

function updateRoleAvailability() {
  db.ref("session").once("value").then(snapshot => {
    const data = snapshot.val() || {};

    // DRIVER
    if ((data.driver && data.driver.role === "driver") || currentRole) {
      driverBtn.disabled = true;
      driverBtn.style.opacity = "0.4";
      driverBtn.innerText = "Driver zajÄ™ty";
    } else {
      driverBtn.disabled = false;
      driverBtn.style.opacity = "1";
      driverBtn.innerText = "Driver";
    }

    // PASSENGER
    if ((data.passenger && data.passenger.role === "passenger") || currentRole) {
      passengerBtn.disabled = true;
      passengerBtn.style.opacity = "0.4";
      passengerBtn.innerText = "Passenger zajÄ™ty";
    } else {
      passengerBtn.disabled = false;
      passengerBtn.style.opacity = "1";
      passengerBtn.innerText = "Passenger";
    }
  });
}




// start pasaÅ¼era
// saveStartBtn.addEventListener("click", () => {
 // const latSuffix = startLat.value.trim();
 // const lngSuffix = startLng.value.trim();

 // if(latSuffix.length === 3 && lngSuffix.length === 3){
  //  const lat = 52.1 + parseInt(latSuffix)/10000;
  //  const lng = 19.9 + parseInt(lngSuffix)/10000;

 //   db.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng })
 //     .then(() => console.log("Nowa lokalizacja startowa pasaÅ¼era zapisana:", lat, lng))
 //     .catch(err => console.error(err));
//  } else {
//    alert("WprowadÅº dokÅ‚adnie 3 cyfry dla szerokoÅ›ci i dÅ‚ugoÅ›ci!");
//  }
// });





// Kierowca â€“ cel
saveDriverDestinationBtn.onclick = () => {
  if (!editingDriverDestination) {
    // WÅ‚Ä…cz tryb edycji
    editingDriverDestination = true;
    saveDriverDestinationBtn.innerText = "Zapisz cel";
    return;
  }

  // Tryb zapisu
  if (selectedPoint) {
  db.ref(`session/users/${userId}/destination`).set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingDriverDestination = false;
  saveDriverDestinationBtn.innerText = "Edytuj cel";
  selectedPoint = null;
};

// PasaÅ¼er â€“ cel
saveDestinationBtn.onclick = () => {
  if (!editingPassengerDestination) {
    editingPassengerDestination = true;
    saveDestinationBtn.innerText = "Zapisz cel";
    return;
  }

  if (selectedPoint) {
db.ref(`session/users/${userId}/destination`).set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingPassengerDestination = false;
  saveDestinationBtn.innerText = "Edytuj cel";
  selectedPoint = null;
};

// PasaÅ¼er â€“ start
saveStartBtn.onclick = () => {
  if (!editingPassengerStart) {
    editingPassengerStart = true;
    saveStartBtn.innerText = "Zapisz start";
    return;
  }

  if (selectedPoint) {
    db.ref("session/passenger/currentLocation").set({
      latitude: selectedPoint[0],
      longitude: selectedPoint[1]
    });
  }

  editingPassengerStart = false;
  saveStartBtn.innerText = "Edytuj start";
  selectedPoint = null;
};


const modeBtn = document.getElementById("modeBtn");

// Zmiana trybu â€“ zapis do Firebase
modeBtn.onclick = () => {
  const newMode = currentMode === "A" ? "B" : "A";
  db.ref("session/mode").set(newMode);  // ðŸ”¹ zapis trybu globalnie
};

// Listener Firebase â€“ reaguje na zmiany trybu
db.ref("session/mode").on("value", snap => {
  const mode = snap.val();
  if (mode) {
    currentMode = mode;
    modeBtn.innerText = "Tryb " + currentMode;
    update(); // ðŸ”¹ odÅ›wieÅ¼ mapÄ™ w nowym trybie
  }
});




const acceptBtn = document.getElementById("acceptBtn");

acceptBtn.onclick = () => {
  if (acceptLocked) return; // ðŸ”’ zabezpieczenie

  acceptLocked = true;

  db.ref("session/accepted").set(true);
  lockFormsAfterAccept();

  acceptBtn.disabled = true;
  acceptBtn.style.opacity = "0.4";
};




function lockFormsAfterAccept() {
  const inputs = document.querySelectorAll(
    "#driverDestinationDiv input, #passengerDestinationDiv input, #passengerStartDiv input"
  );
  const buttons = document.querySelectorAll(
    "#driverDestinationDiv button, #passengerDestinationDiv button, #passengerStartDiv button"
  );

  inputs.forEach(i => i.disabled = true);
  buttons.forEach(b => {
    b.disabled = true;
    b.style.opacity = "0.4";
  });
}



</script>
</body>
</html>
