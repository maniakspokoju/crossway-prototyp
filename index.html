<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Crossway 2.2 – trasy po drogach</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        body { font-family: sans-serif; margin: 10px; }
        #map { height: 500px; margin-top: 20px; display:none; }
        #passengerDestinationDiv { display:none; margin-top:10px; }
        input { width: 100px; margin-right: 5px; }
    </style>
</head>
<body>
    <h1>Crossway 2.5 – trasy po drogach</h1>
    <p>Wybierz swoją rolę i sprawdź geolokalizację</p>

    <button id="driverBtn">Driver</button>
    <button id="passengerBtn">Passenger</button>
    <p id="role"></p>

    <div id="passengerDestinationDiv">
        <h3>Wskaż lokalizację docelową:</h3>
        <input type="number" id="destLat" placeholder="###" step="0.001">
        <input type="number" id="destLng" placeholder="###" step="0.001">
        <button id="saveDestinationBtn">Zapisz cel</button>
    </div>

    <div id="map"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
    // ===================== CONFIG FIREBASE =====================
    const firebaseConfig = {
      apiKey: "AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
      authDomain: "crossway-prototyp.firebaseapp.com",
      projectId: "crossway-prototyp",
      storageBucket: "crossway-prototyp.firebasestorage.app",
      messagingSenderId: "852476458596",
      appId: "1:852476458596:web:f901da16de7dc8a3551171",
      databaseURL: "https://crossway-prototyp-default-rtdb.europe-west1.firebasedatabase.app/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Reset sesji dla testów
    db.ref("session").remove()
      .then(() => console.log("Sesja zresetowana"))
      .catch(err => console.error(err));

    let currentRole = null;

    // ===================== FUNKCJA PRZYDZIAŁU ROLI =====================
    function assignRole(role) {
        currentRole = role;
        document.getElementById("role").innerText = "Twoja rola: " + role;

        db.ref(`session/${role}`).set({role: role})
          .then(() => console.log("Rola zapisana:", role))
          .catch(err => console.error(err));

        if (role === "driver" && "geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;

                db.ref("session/driver/currentLocation").set({ latitude: lat, longitude: lng });
                const destLat = lat + 0.018;
                const destLng = lng + 0.018;
                db.ref("session/driver/destination").set({ latitude: destLat, longitude: destLng });
            }, err => console.error(err.message));
        }

        if (role === "passenger") {
            document.getElementById("passengerDestinationDiv").style.display = "block";
            document.getElementById("map").style.display = "block";

            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    db.ref("session/passenger/currentLocation").set({ latitude: lat, longitude: lng });
                }, err => console.error(err.message));
            }
        }
    }

    document.getElementById("driverBtn").addEventListener("click", () => assignRole("driver"));
    document.getElementById("passengerBtn").addEventListener("click", () => assignRole("passenger"));

    // ===================== MAPA =====================
    const map = L.map('map').setView([52.2297, 21.0122], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const driverMarker = L.marker([0,0]).addTo(map);
    const driverDestMarker = L.marker([0,0]).addTo(map);
    const passengerMarker = L.marker([0,0]).addTo(map);
    const passengerDestMarker = L.marker([0,0]).addTo(map);

    const driverPolyline = L.polyline([], { color: 'blue', weight: 5 }).addTo(map);
    const passengerPolyline = L.polyline([], { color: 'green', weight: 5 }).addTo(map);

    // ===================== OSRM – TRASY PO DROGACH =====================
    async function fetchRouteOSRM(start, end) {
        const url = `https://router.project-osrm.org/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?overview=full&geometries=geojson`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.routes || !data.routes.length) return [];
        return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
    }

    // ===================== AKTUALIZACJA MAPY =====================
    async function updateMarkersAndLines() {
        const ds = (await db.ref("session/driver/currentLocation").once("value")).val();
        const de = (await db.ref("session/driver/destination").once("value")).val();
        const ps = (await db.ref("session/passenger/currentLocation").once("value")).val();
        const pe = (await db.ref("session/passenger/destination").once("value")).val();

        if(ds && de){
            const dStart = [ds.latitude, ds.longitude];
            const dEnd = [de.latitude, de.longitude];
            driverMarker.setLatLng(dStart);
            driverDestMarker.setLatLng(dEnd);
            const route = await fetchRouteOSRM(dStart, dEnd);
            driverPolyline.setLatLngs(route);
        }

        if(ps && pe){
            const pStart = [ps.latitude, ps.longitude];
            const pEnd = [pe.latitude, pe.longitude];
            passengerMarker.setLatLng(pStart);
            passengerDestMarker.setLatLng(pEnd);
            const route = await fetchRouteOSRM(pStart, pEnd);
            passengerPolyline.setLatLngs(route);
        }
    }

    db.ref("session").on("value", () => updateMarkersAndLines());

    // ===================== ZAPIS LOKALIZACJI PASAŻERA =====================
    document.getElementById("saveDestinationBtn").addEventListener("click", () => {
        const latSuffix = document.getElementById("destLat").value.trim();
        const lngSuffix = document.getElementById("destLng").value.trim();
        if(latSuffix.length === 3 && lngSuffix.length === 3){
            const lat = 52.1 + parseInt(latSuffix)/10000;
            const lng = 19.9 + parseInt(lngSuffix)/10000;
            db.ref("session/passenger/destination").set({ latitude: lat, longitude: lng });
        } else {
            alert("Wprowadź dokładnie 3 cyfry dla szerokości i długości!");
        }
    });
// Obsługa przycisków
document.getElementById("driverBtn").addEventListener("click", () => assignRole("driver"));
document.getElementById("passengerBtn").addEventListener("click", () => assignRole("passenger"));
</script>
</body>
</html>
</body>
</html>
