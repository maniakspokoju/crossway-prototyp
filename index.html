<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway – Szachownica</title>

<style>
body { font-family: Arial; margin: 20px; }

#grid { border-collapse: collapse; margin-top: 20px; }
#grid td { 
  width: 42px; height: 42px; 
  border: 1px solid #999; 
  padding: 0;
  cursor: pointer;
}

.cell {
  width: 100%;
  height: 50%;
}

.driver { border-bottom: 1px solid #aaa; }
.passenger {}

.axis { font-weight: bold; background: #eee; }

#controls button { margin-right: 5px; }

.driverColor {
  width: 18px;
  height: 18px;
  display: inline-block;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>

<body>

<h1>Crossway – model logiczny</h1>

<div>
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">Pasażer</button>
</div>

<div id="controls">
  <button id="prevBtn">⬅</button>
  <button id="nextBtn">➡</button>
  <button id="acceptBtn">AKCEPTUJ</button>
  <button id="resetBtn">RESET</button>
</div>

<table id="grid"></table>

<h2>Dane użytkowników</h2>
<table border="1" width="100%" id="usersTable">
<thead></thead>
<tbody></tbody>
</table>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  databaseURL: "https://crossway-prototyp-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* ================= STAN ================= */
const ROWS = 8, COLS = 8;
const userId = crypto.randomUUID();

let role = null;
let start = null;
let end = null;
let users = {};
let matchedDrivers = [];
let selected = 0;

/* ================= GRID ================= */
const grid = document.getElementById("grid");

function initGrid() {
  grid.innerHTML = "";

  let header = "<tr><td></td>";
  for(let c=1;c<=COLS;c++) header+=`<td class="axis">${c}</td>`;
  header+="</tr>";
  grid.innerHTML += header;

  for(let r=0;r<ROWS;r++){
    let row = `<tr><td class="axis">${String.fromCharCode(65+r)}</td>`;
    for(let c=0;c<COLS;c++){
      row += `
      <td onclick="cellClick(${r},${c})">
        <div class="cell driver"></div>
        <div class="cell passenger"></div>
      </td>`;
    }
    row+="</tr>";
    grid.innerHTML += row;
  }
}

window.cellClick = (r,c)=>{
  if(!role) return;

  if(!start) start={r,c};
  else if(!end){
    if(start.r!==r && start.c!==c){
      alert("Tylko linia prosta");
      return;
    }
    end={r,c};
    save();
  }
  render();
};

function save(){
  db.ref("users/"+userId).set({
    role,
    start,
    end,
    color: role==="driver" ? randColor() : null,
    accepted: null
  });
}

/* ================= RYSOWANIE ================= */
function clearGrid(){
  document.querySelectorAll(".driver,.passenger").forEach(d=>{
    d.style.background="";
  });
}

function routeCells(a,b){
  let out=[];
  if(a.r===b.r)
    for(let c=Math.min(a.c,b.c);c<=Math.max(a.c,b.c);c++) out.push({r:a.r,c});
  else
    for(let r=Math.min(a.r,b.r);r<=Math.max(a.r,b.r);r++) out.push({r,c:a.c});
  return out;
}

function paint(cell,who,color){
  const td = grid.rows[cell.r+1].cells[cell.c+1];
  td.querySelector(`.${who}`).style.background=color;
}

function render(){
  clearGrid();
  if(start && end){
    routeCells(start,end).forEach(c=>{
      paint(c, role==="driver"?"driver":"passenger", role==="driver"?"#bbb":"#7fdc7f");
    });
  }

  if(role==="passenger" && matchedDrivers[selected]){
    const d = matchedDrivers[selected];
    routeCells(d.start,d.end).forEach(c=>{
      paint(c,"driver",d.color);
    });

    const shared = routeCells(start,end).filter(p =>
      routeCells(d.start,d.end).some(q=>q.r===p.r && q.c===p.c)
    );
    shared.forEach(c=>{
      paint(c,"driver",d.color);
      paint(c,"passenger",d.color);
    });
  }

  if(role==="driver"){
    Object.values(users).forEach(u=>{
      if(u.accepted===userId){
        routeCells(u.start,u.end).forEach(c=>{
          paint(c,"passenger","#7fdc7f");
        });
      }
    });
  }
}

/* ================= MATCHING ================= */
function recompute(){
  matchedDrivers=[];
  if(role!=="passenger" || !start || !end) return;

  Object.entries(users).forEach(([id,u])=>{
    if(u.role==="driver"){
      const shared = routeCells(start,end)
        .some(p=>routeCells(u.start,u.end)
        .some(q=>q.r===p.r && q.c===p.c));
      if(shared) matchedDrivers.push({...u,id});
    }
  });
  selected=0;
}

/* ================= UI ================= */
driverBtn.onclick=()=>{
  role="driver";
  document.body.style.background="#ddeeff";
  lockRole();
};

passengerBtn.onclick=()=>{
  role="passenger";
  document.body.style.background="#ddffdd";
  lockRole();
};

function lockRole(){
  driverBtn.disabled=true;
  passengerBtn.disabled=true;
}

nextBtn.onclick=()=>{ selected=(selected+1)%matchedDrivers.length; render(); };
prevBtn.onclick=()=>{ selected=(selected-1+matchedDrivers.length)%matchedDrivers.length; render(); };

acceptBtn.onclick=()=>{
  const d=matchedDrivers[selected];
  db.ref("users/"+d.id+"/accepted").set(userId);
  disableControls();
};

resetBtn.onclick=()=> db.ref("users").remove();

function disableControls(){
  document.querySelectorAll("button").forEach(b=>b.disabled=true);
}

/* ================= TABLE ================= */
function renderTable(){
  const head=document.querySelector("#usersTable thead");
  const body=document.querySelector("#usersTable tbody");
  head.innerHTML="<tr><th>ID</th><th>Rola</th></tr>";
  body.innerHTML="";

  Object.entries(users).forEach(([id,u])=>{
    body.innerHTML+=`<tr><td>${id.slice(0,6)}</td><td>${u.role}</td></tr>`;
  });
}

/* ================= FIREBASE ================= */
db.ref("users").on("value",snap=>{
  users=snap.val()||{};
  recompute();
  render();
  renderTable();
});

initGrid();

function randColor(){
  return `hsl(${Math.random()*360},70%,60%)`;
}
</script>
</body>
</html>
