<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Crossway – Szachownica</title>
<style>
  body { font-family: Arial, sans-serif; }
  #roleSelect { margin: 10px 0; }
  #grid { border-collapse: collapse; margin: 20px 0; }
  #grid td { width: 40px; height: 40px; border: 1px solid #aaa; text-align: center; vertical-align: middle; cursor: pointer; }
  .driverCell { background-color: #add8e6; }
  .passengerCell { background-color: #90ee90; }
  .sharedCell { background-color: #ff6961; }
  #usersTable { margin-top: 20px; border-collapse: collapse; width: 100%; }
  #usersTable th, #usersTable td { border: 1px solid #000; padding: 5px; text-align: center; }
  .driverColorBox { display:inline-block; width:20px; height:20px; vertical-align:middle; margin-right:5px; }
  #controls { margin-top: 10px; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

<h1>Crossway – Szachownica 2</h1>

<div id="roleSelect">
  <button id="driverBtn">Kierowca</button>
  <button id="passengerBtn">Pasażer</button>
</div>

<div id="controls">
  <button id="prevDriverBtn">⬅ Cofnij</button>
  <button id="nextDriverBtn">➡ Dalej</button>
  <button id="acceptBtn">✅ Akceptuj</button>
  <button id="resetBtn">⛔ Zakończ przejazd</button>
</div>

<table id="grid"></table>

<h2>Użytkownicy / trasy</h2>
<table id="usersTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Rola</th>
      <th>Kolor</th>
      <th>Start</th>
      <th>Cel</th>
      <th colspan="0" id="passengerHeaders">Pasażerowie</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ===== FIREBASE =====
firebase.initializeApp({
 apiKey:"AIzaSyBO8O-tNlduXs3VPr5UV8-A1MWesj1ptrc",
 databaseURL:"https://crossway-prototyp-default-rtdb.europe-west1.firebasedataba
});
const db = firebase.database();
const userRef = db.ref("users/" + userId);


  // ====== STANY ======
  const ROWS = 8, COLS = 8;
  let userId = crypto.randomUUID();
  let role = null; // 'driver' lub 'passenger'
  let gridStart = null;
  let gridEnd = null;
  let usersData = {};
  let matchedDrivers = [];
  let selectedDriverIndex = 0;
  let driverColors = {};

  // ====== ELEMENTY ======
  const gridEl = document.getElementById('grid');
  const driverBtn = document.getElementById('driverBtn');
  const passengerBtn = document.getElementById('passengerBtn');
  const prevDriverBtn = document.getElementById('prevDriverBtn');
  const nextDriverBtn = document.getElementById('nextDriverBtn');
  const acceptBtn = document.getElementById('acceptBtn');
  const resetBtn = document.getElementById('resetBtn');
  const usersTableBody = document.querySelector('#usersTable tbody');
  const passengerHeaders = document.getElementById('passengerHeaders');

  // ====== INICJALIZACJA GRIDU ======
  function initGrid() {
    gridEl.innerHTML = '';
    const header = document.createElement('tr');
    header.innerHTML = '<th></th>' + [...Array(COLS)].map((_,c)=>`<th>${c+1}</th>`).join('');
    gridEl.appendChild(header);
    for(let r=0;r<ROWS;r++){
      let tr = document.createElement('tr');
      tr.innerHTML = `<th>${String.fromCharCode(65+r)}</th>`;
      for(let c=0;c<COLS;c++){
        let td = document.createElement('td');
        td.dataset.row = r;
        td.dataset.col = c;
        td.onclick = () => cellClick(r,c);
        tr.appendChild(td);
      }
      gridEl.appendChild(tr);
    }
  }

  function cellClick(r,c){
    if(!role) return;
    if(!gridStart){
      gridStart = {r,c};
      updateGrid();
    } else if(!gridEnd){
      gridEnd = {r,c};
      if(gridStart.r!==gridEnd.r && gridStart.c!==gridEnd.c){
        alert("Trasa musi być w linii prostej!");
        gridEnd=null;
        return;
      }
      saveRoute();
      updateGrid();
    }
  }

  function saveRoute(){
    const start = `${gridStart.r},${gridStart.c}`;
    const end = `${gridEnd.r},${gridEnd.c}`;
    let color = role==='driver'? getRandomColor() : null;
    if(role==='driver') driverColors[userId]=color;
    db.ref("users/"+userId).set({
      role,
      start,
      end,
      color,
      acceptedBy: null
    });
  }

  function getRandomColor(){
    const letters='0123456789ABCDEF';
    let color='#';
    for(let i=0;i<6;i++) color+=letters[Math.floor(Math.random()*16)];
    return color;
  }

  function parseCell(str){ const [r,c]=str.split(',').map(Number); return {r,c}; }

  function drawRoute(start,end,className){
    if(start.r===end.r)
      for(let c=Math.min(start.c,end.c);c<=Math.max(start.c,end.c);c++)
        gridEl.rows[start.r+1].cells[c+1].classList.add(className);
    else
      for(let r=Math.min(start.r,end.r);r<=Math.max(start.r,end.r);r++)
        gridEl.rows[r+1].cells[start.c+1].classList.add(className);
  }

  function getRouteCells(start,end){
    let cells=[];
    if(start.r===end.r)
      for(let c=Math.min(start.c,end.c);c<=Math.max(start.c,end.c);c++) cells.push({r:start.r,c});
    else
      for(let r=Math.min(start.r,end.r);r<=Math.max(start.r,end.r);r++) cells.push({r,c:start.c});
    return cells;
  }

  function getSharedCells(cells1,cells2){
    return cells1.filter(c1=>cells2.some(c2=>c1.r===c2.r && c1.c===c2.c));
  }

  // ====== OBSŁUGA PRZYCISKÓW ======
  driverBtn.onclick = ()=>{
    role='driver';
    gridStart=null; gridEnd=null;
    document.body.style.backgroundColor="#add8e6";
    initGrid();
    driverBtn.disabled=true; passengerBtn.disabled=true;
  };
  passengerBtn.onclick = ()=>{
    role='passenger';
    gridStart=null; gridEnd=null;
    document.body.style.backgroundColor="#90ee90";
    initGrid();
    driverBtn.disabled=true; passengerBtn.disabled=true;
  };

  nextDriverBtn.onclick = ()=>{
    if(matchedDrivers.length===0) return;
    selectedDriverIndex = (selectedDriverIndex+1)%matchedDrivers.length;
    updateGrid();
  };
  prevDriverBtn.onclick = ()=>{
    if(matchedDrivers.length===0) return;
    selectedDriverIndex = (selectedDriverIndex-1 + matchedDrivers.length)%matchedDrivers.length;
    updateGrid();
  };

  acceptBtn.onclick = ()=>{
    if(role!=='passenger' || matchedDrivers.length===0) return;
    const driver = matchedDrivers[selectedDriverIndex];
    db.ref("users/"+driver.id+"/acceptedBy").set(userId);
    disableButtons(driver.id,userId);
    updateGrid();
  };

  resetBtn.onclick = ()=>{
    db.ref("users").remove();
    gridStart=null; gridEnd=null;
    matchedDrivers=[];
    selectedDriverIndex=0;
    driverColors={};
    initGrid();
  };

  function disableButtons(driverId,passengerId){
    if(driverId===userId || passengerId===userId) {
      driverBtn.disabled=true; passengerBtn.disabled=true;
      prevDriverBtn.disabled=true; nextDriverBtn.disabled=true;
      acceptBtn.disabled=true;
    }
  }

  // ====== OBSŁUGA DANYCH FIREBASE ======
  function refreshUsers(snapshot){
    usersData=snapshot.val()||{};
    updateUsersTable();
    updateMatchedDrivers();
    updateGrid();
  }

  function updateMatchedDrivers(){
    matchedDrivers=[];
    if(role!=='passenger' || !gridStart) return;
    let ps = gridStart;
    let count=0;
    Object.entries(usersData).forEach(([id,u])=>{
      if(u.role==='driver' && u.start && u.end){
        const dCells=getRouteCells(parseCell(u.start),parseCell(u.end));
        const pCells=getRouteCells(gridStart,gridEnd||gridStart); // jeśli pasażer nie wybrał jeszcze celu
        if(pCells.some(pc=>dCells.some(dc=>dc.r===pc.r && dc.c===pc.c))){
          matchedDrivers.push({...u,id});
        }
      }
    });
    selectedDriverIndex=0;
  }

  function updateGrid(){
    // wyczyść grid
    for(let r=1;r<=ROWS;r++){
      for(let c=1;c<=COLS;c++){
        gridEl.rows[r].cells[c].className='';
      }
    }
    // własna trasa
    if(gridStart && gridEnd){
      drawRoute(gridStart,gridEnd, role==='driver' ? 'driverCell':'passengerCell');
    }
    // dla pasażera: trasy dopasowanych kierowców
    if(role==='passenger'){
      matchedDrivers.forEach((driver,idx)=>{
        const dStart=parseCell(driver.start);
        const dEnd=parseCell(driver.end);
        drawRoute(dStart,dEnd,'driverCell');
        if(gridStart && gridEnd){
          const shared=getSharedCells(getRouteCells(dStart,dEnd),getRouteCells(gridStart,gridEnd));
          shared.forEach(c=>{
            gridEl.rows[c.r+1].cells[c.c+1].classList.add('sharedCell');
          });
        }
      });
    }
    // dla kierowcy: pokaż zaakceptowane pasażery
    if(role==='driver'){
      Object.entries(usersData).forEach(([id,u])=>{
        if(u.acceptedBy===userId){
          const pStart=parseCell(u.start);
          const pEnd=parseCell(u.end);
          drawRoute(pStart,pEnd,'passengerCell');
          const dCells=getRouteCells(parseCell(u.start),parseCell(u.end));
          const shared=getSharedCells(getRouteCells(parseCell(u.start),parseCell(u.end)),getRouteCells(parseCell(u.start),parseCell(u.end)));
          shared.forEach(c=>{
            gridEl.rows[c.r+1].cells[c.c+1].classList.add('sharedCell');
          });
        }
      });
    }
  }

  function updateUsersTable(){
    usersTableBody.innerHTML='';
    // przygotuj kolumny pasażerów
    const passengerIds=[];
    Object.entries(usersData).forEach(([id,u])=>{
      if(u.role==='passenger') passengerIds.push(id);
    });
    // nagłówki
    const thRow = usersTableBody.parentNode.querySelector('thead tr');
    // usuń stare nagłówki pasażerów
    Array.from(thRow.querySelectorAll('.passengerCol')).forEach(el=>el.remove());
    passengerIds.forEach((pid,idx)=>{
      const th=document.createElement('th');
      th.textContent=idx+1;
      th.classList.add('passengerCol');
      thRow.appendChild(th);
    });

    // wiersze kierowców
    Object.entries(usersData).forEach(([id,u])=>{
      const tr=document.createElement('tr');
      let colorBox='';
      if(u.role==='driver' && u.color){
        colorBox=`<span class="driverColorBox" style="background-color:${u.color}"></span>`;
      }
      let cells = `<td>${id.slice(0,6)}</td><td>${u.role||''}</td><td>${colorBox}</td><td>${u.start||''}</td><td>${u.end||''}</td>`;
      if(u.role==='driver'){
        passengerIds.forEach(pid=>{
          const p=usersData[pid];
          let val='';
          if(p && p.start && p.end){
            const dCells=getRouteCells(parseCell(u.start),parseCell(u.end));
            const pCells=getRouteCells(parseCell(p.start),parseCell(p.end));
            if(getSharedCells(dCells,pCells).length>0) val='✓';
          }
          cells+=`<td>${val}</td>`;
        });
      } else {
        const driverCount=Object.entries(usersData).filter(([id,u])=>u.role==='driver').length;
        cells+=`<td colspan="${driverCount}"></td>`;
      }
      tr.innerHTML=cells;
      usersTableBody.appendChild(tr);
    });
  }

  db.ref("users").on('value',refreshUsers);

  initGrid();
</script>
</body>
</html>
